---
phase: 32-inner-thoughts-timing
plan: 01
type: tdd
---

<objective>
Build the inner thoughts evaluation module — a post-session LLM check of whether proactive follow-up is warranted.

Purpose: After a user session ends, evaluate whether there's a clear reason to proactively reach out (unresolved questions, stale goals, behavioral shifts). This is the "inner monologue" that decides WHAT to say and WHETHER to say it — distinct from the gap scanner (which detects signals) and the timing model (which decides WHEN).
Output: Working, tested `inner-thoughts.ts` with `shouldRunInnerThoughts` pre-filter, `evaluateInnerThoughts` LLM evaluator, prompt builder, and response parser.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-inner-thoughts-timing/32-RESEARCH.md

# Key prior summaries:
@.planning/phases/31-gap-scanner/31-02-SUMMARY.md
@.planning/phases/31-gap-scanner/31-03-SUMMARY.md

# Source files (patterns to follow):
@src/memory/gap-diagnosis.ts
@src/memory/reflection.ts
@src/memory/gap-scanner.ts
@src/memory/affect-smoothing.ts
@src/memory/trust-score.ts
@src/memory/db.ts

**Established patterns:**
- Prompt-builder + parser + orchestrator (gap-diagnosis.ts) — follow exactly
- Fail-safe invariant: all error paths → 'skip' decision with reason (not crash)
- JSON extraction regex for LLM response tolerance (from gap-diagnosis.ts)
- Pure functions with injectable `now` for deterministic testing
- SmoothedAffect + goalSignal for affect suppression
- fusionProvider reuse pattern (same fast-tier LLM)

**Constraining decisions:**
- Phase 31: GapSignal type defines the signal format inner thoughts receives
- Phase 25: SmoothedAffect/GoalSignal types for affect-based suppression
- Phase 24: Trust score proactivenessDial for gating
- RESEARCH.md: Run in deepTick (6h cycle), not sleepTick — inner thoughts acts on recent sessions
</context>

<feature>
  <name>Inner Thoughts Evaluation Module</name>
  <files>src/memory/inner-thoughts.ts, src/memory/inner-thoughts.test.ts</files>
  <behavior>
    **Types:**
    - `InnerThoughtsInput`: sessionSummary (SessionSummaryRow), recentGapSignals (GapSignal[]), affect (SmoothedAffect | null), dial ('conservative' | 'moderate' | 'eager'), lastProactiveAt (number | null), activeHours (number[])
    - `InnerThoughtsResult`: decision ('proact' | 'wait' | 'skip'), reason (string), message (string | undefined), urgency ('low' | 'medium' | 'high')

    **shouldRunInnerThoughts(input: InnerThoughtsInput, now?: number): boolean**
    Pre-filter — no LLM, pure logic:
    - Returns false if lastProactiveAt within 6 hours of now
    - Returns false if affect?.goalSignal === 'user_distressed'
    - Returns false if sessionSummary.messageCount < 3
    - Returns true if recentGapSignals.length > 0
    - Returns true if dial !== 'conservative'
    - Returns false otherwise (conservative with no signals)

    **buildInnerThoughtsPrompt(input: InnerThoughtsInput): CompletionRequest**
    Prompt builder — returns request object, no LLM call:
    - System prompt instructs LLM to evaluate whether proactive follow-up is warranted
    - Includes session summary, gap signals, affect, dial in user message
    - Instructs: "When in doubt, recommend skip. False silence > false alarm."
    - Requires JSON response: {"decision": "proact|wait|skip", "reason": "...", "message": "...", "urgency": "low|medium|high"}
    - temperature: 0.2, maxTokens: 200

    **parseInnerThoughtsResponse(response: string): InnerThoughtsResult**
    Parser — extracts JSON from LLM response:
    - Extracts JSON from response (may have markdown wrapping)
    - Validates decision is one of 'proact' | 'wait' | 'skip'
    - Validates urgency is one of 'low' | 'medium' | 'high'
    - On parse failure: returns { decision: 'skip', reason: 'Failed to parse LLM response', urgency: 'low' }
    - On invalid decision value: returns skip with reason

    **evaluateInnerThoughts(input: InnerThoughtsInput, provider: LLMProvider): Promise<InnerThoughtsResult>**
    Orchestrator:
    - Calls shouldRunInnerThoughts → if false, returns { decision: 'skip', reason: '[specific reason]', urgency: 'low' }
    - Calls buildInnerThoughtsPrompt
    - Calls provider.complete
    - Calls parseInnerThoughtsResponse
    - On LLM error: returns { decision: 'skip', reason: 'LLM error: [message]', urgency: 'low' }

    **Test cases:**
    - shouldRunInnerThoughts: returns false when lastProactive within 6h
    - shouldRunInnerThoughts: returns false when user distressed
    - shouldRunInnerThoughts: returns false when session too short (< 3 messages)
    - shouldRunInnerThoughts: returns true when gap signals exist
    - shouldRunInnerThoughts: returns true when dial is moderate/eager with no signals
    - shouldRunInnerThoughts: returns false when conservative with no signals
    - buildInnerThoughtsPrompt: returns CompletionRequest with correct structure
    - buildInnerThoughtsPrompt: includes gap signals in user message when present
    - buildInnerThoughtsPrompt: includes "None" for gap signals when empty
    - buildInnerThoughtsPrompt: includes affect emotion when available, 'unknown' when null
    - parseInnerThoughtsResponse: parses valid JSON response
    - parseInnerThoughtsResponse: handles markdown-wrapped JSON (```json ... ```)
    - parseInnerThoughtsResponse: returns skip on invalid JSON
    - parseInnerThoughtsResponse: returns skip on invalid decision value
    - parseInnerThoughtsResponse: defaults urgency to 'low' if missing
    - evaluateInnerThoughts: returns skip when pre-filter rejects
    - evaluateInnerThoughts: calls LLM and returns parsed result on success
    - evaluateInnerThoughts: returns skip on LLM error (fail-safe)
  </behavior>
  <implementation>
    Follow the gap-diagnosis.ts pattern exactly:
    - Types at top of file (exported)
    - shouldRunInnerThoughts as exported pure function
    - buildInnerThoughtsPrompt as exported pure function returning CompletionRequest
    - parseInnerThoughtsResponse as exported pure function
    - evaluateInnerThoughts as exported async orchestrator
    - Use the same JSON extraction regex from gap-diagnosis.ts: /\{[\s\S]*\}/
    - Import types: SessionSummaryRow from db.ts, GapSignal from gap-scanner.ts, SmoothedAffect from affect-smoothing.ts, LLMProvider/CompletionRequest from providers/types.ts
    - Do NOT import ContentBlock — extract text from response.content using the same pattern as gap-diagnosis.ts
  </implementation>
</feature>

<verification>
npx vitest run src/memory/inner-thoughts.test.ts --reporter=verbose
All 18 tests pass.
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed
- All 2-3 commits present
- shouldRunInnerThoughts correctly gates on all 6 conditions
- Fail-safe invariant: all error paths → skip decision (never throws)
- Prompt follows gap-diagnosis.ts pattern (builder + parser + orchestrator)
</success_criteria>

<output>
After completion, create `.planning/phases/32-inner-thoughts-timing/32-01-SUMMARY.md`
</output>
