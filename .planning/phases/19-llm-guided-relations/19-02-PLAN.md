---
phase: 19-llm-guided-relations
plan: 02
type: execute
---

<objective>
Wire LLM provider through gateway and ScallopMemoryStore into RelationGraph for LLM-based relation classification.

Purpose: Connect the LLM-based classifyRelation (built in 19-01) to the live system so memory relations are classified by LLM instead of regex in production.
Output: End-to-end LLM relation classification working through gateway → ScallopMemoryStore → RelationGraph.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-llm-guided-relations/19-RESEARCH.md
@.planning/phases/19-llm-guided-relations/19-01-SUMMARY.md

# Key files:
@src/memory/scallop-store.ts
@src/gateway/gateway.ts
@src/memory/relations.ts

**Tech stack available:** RelationshipClassifier, LLMProvider, CostTracker, rerankProvider pattern
**Established patterns:** opt-in provider injection (rerankProvider in ScallopMemoryStoreOptions), inline Groq adapter for standalone skills
**Constraining decisions:**
- Phase 18: Opt-in rerankProvider via constructor, graceful degradation
- Phase 19-01: classifierProvider in RelationGraph constructor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add relationsProvider to ScallopMemoryStore and pass to RelationGraph</name>
  <files>src/memory/scallop-store.ts</files>
  <action>
    1. Add `relationsProvider?: LLMProvider` to `ScallopMemoryStoreOptions` interface (follows same pattern as rerankProvider)
    2. In constructor, pass `options.relationsProvider` to `RelationGraph` constructor as the `classifierProvider` parameter:
       `this.relationGraph = new RelationGraph(this.db, this.embedder, options.relationOptions, options.relationsProvider);`
    3. No other changes needed — the existing `detectRelations` call path in `add()` already delegates to `relationGraph.detectRelations()` which now uses LLM internally

    Avoid: Don't add a separate `relationsProvider` field to the class — it's only needed during construction to pass to RelationGraph. Don't change any other code paths (fact-extractor passes `detectRelations: false`, so it's unaffected).
  </action>
  <verify>npx vitest run src/memory/scallop.test.ts — all existing tests pass (no behavior change without provider)</verify>
  <done>ScallopMemoryStoreOptions has relationsProvider field, RelationGraph receives it in constructor, all existing tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Wire relationsProvider in gateway initialization</name>
  <files>src/gateway/gateway.ts</files>
  <action>
    1. In the gateway's memory store initialization section (where rerankProvider is already obtained), reuse the same fast-tier provider for relations classification:
       - The rerankProvider is already obtained via `await this.router.selectProvider('fast')`
       - Pass the same provider as `relationsProvider` in the ScallopMemoryStore constructor options
       - This avoids a second selectProvider call and keeps both features using the same fast/cheap tier
    2. The code should look like:
       ```
       this.scallopMemoryStore = new ScallopMemoryStore({
         dbPath,
         logger: this.logger,
         embedder,
         rerankProvider,
         relationsProvider: rerankProvider,
       });
       ```

    Avoid: Don't create a separate provider selection for relations — reuse rerankProvider. Both features need a fast, cheap LLM for scoring/classification tasks. Don't add error handling beyond what already exists for rerankProvider.
  </action>
  <verify>npx vitest run src/memory/ — all memory tests pass, gateway compiles without errors</verify>
  <done>Gateway passes fast-tier provider as relationsProvider alongside rerankProvider, both features share same provider</done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for LLM-based relation detection through ScallopMemoryStore</name>
  <files>src/memory/scallop.test.ts</files>
  <action>
    Add 2 integration tests in the existing ScallopMemoryStore test suite:

    1. "should use LLM classifier for relation detection when relationsProvider is set":
       - Create a mock LLMProvider that returns a valid classification response (UPDATES with targetId)
       - Create ScallopMemoryStore with relationsProvider set to mock + a TFIDFEmbedder
       - Store two related memories with detectRelations: true
       - Verify the mock provider's complete() was called (LLM was invoked for classification)
       - Verify UPDATES relation was created between the memories

    2. "should fall back to regex when LLM classification fails":
       - Create a mock LLMProvider that throws an error
       - Create ScallopMemoryStore with relationsProvider set to failing mock + TFIDFEmbedder
       - Store two memories with similar content that regex would catch (e.g., "Lives in Dublin" and "Lives in Cork")
       - Verify relation is still detected via regex fallback despite LLM failure

    Follow existing test patterns in scallop.test.ts — use TEST_DB_PATH, cleanupTestDb(), TFIDFEmbedder for embeddings.
  </action>
  <verify>npx vitest run src/memory/scallop.test.ts — all tests pass including new integration tests</verify>
  <done>2 integration tests verify LLM classification works through ScallopMemoryStore and graceful fallback on LLM failure</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx vitest run src/memory/` passes all tests
- [ ] No TypeScript errors (`npx tsc --noEmit`)
- [ ] Existing behavior unchanged when no relationsProvider is set
- [ ] LLM-based classification works end-to-end through gateway → store → RelationGraph
- [ ] Graceful fallback to regex on LLM failure verified by test
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- LLM relation classification works through full stack
- Backward compatibility: no relationsProvider = regex behavior
- Phase 19 complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-llm-guided-relations/19-02-SUMMARY.md`
</output>
