---
phase: 27-dream-nrem-consolidation
plan: 02
type: tdd
---

<objective>
Create `nrem-consolidation.ts` — the NREM consolidation module with relation-context-enriched fusion prompts and an orchestrator function.

Purpose: NREM consolidation enhances deep-tick fusion with (1) wider prominence window [0.05, 0.8), (2) cross-category clustering (from 27-01), and (3) relation context in the LLM fusion prompt. The relation context tells the LLM *why* memories from different categories are connected, enabling coherent cross-category synthesis (e.g., "interest in Rust" + "frustration with Node.js" → "migration intent").

Output: Pure `nremConsolidate()` function, `buildNremFusionPrompt()` with relation context, `buildRelationContext()` helper, full TDD coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-dream-nrem-consolidation/27-RESEARCH.md
@.planning/phases/27-dream-nrem-consolidation/27-01-SUMMARY.md

# Key source files:
@src/memory/fusion.ts
@src/memory/fusion.test.ts
@src/memory/db.ts
@src/memory/relations.ts
@src/providers/types.ts

# Prior phase summaries:
@.planning/phases/21-memory-fusion-engine/21-01-SUMMARY.md
@.planning/phases/21-memory-fusion-engine/21-02-SUMMARY.md

**Established patterns:**
- Pure functions: data + callbacks, no DB injection (fusion.ts, relations.ts)
- LLMProvider injection for LLM calls (fuseMemoryCluster pattern)
- CompletionRequest with system + user messages (buildFusionPrompt pattern)
- Graceful null return on LLM failure (fuseMemoryCluster pattern)
- JSON parsing with regex extraction (parseFusionResponse pattern)

**Constraining decisions:**
- Phase 21: fuseMemoryCluster() returns null on any failure — NREM follows same pattern
- Phase 27 RESEARCH: Use `learnedFrom: 'nrem_consolidation'` to distinguish from daytime `consolidation`
- Phase 27 RESEARCH: Cap relation context to 3 per memory (maxRelationsPerMemory), intra-cluster only
- Phase 27 RESEARCH: For cross-category clusters, default fused category to `insight`

**RESEARCH.md Don't Hand-Roll:**
- LLM fusion call — extend `fuseMemoryCluster()` pattern (JSON parsing, validation, error handling)
- BFS cluster detection — reuse `findFusionClusters()` (from 27-01 with crossCategory: true)
</context>

<feature>
  <name>NREM consolidation with relation context</name>
  <files>src/memory/nrem-consolidation.ts, src/memory/nrem-consolidation.test.ts</files>
  <behavior>
    buildRelationContext(cluster, getRelations, maxPerMemory):
    - Input: cluster of 3 memories with intra-cluster relations
    - Expected: array of RelationContextEntry with memoryIndex, relationType, targetIndex, targetContent (≤80 chars), confidence
    - Caps at maxPerMemory (default 3) relations per memory
    - Only includes intra-cluster relations (ignores relations to memories outside cluster)

    buildNremFusionPrompt(cluster, relationContext):
    - Input: cluster + relation context entries
    - Expected: CompletionRequest with:
      - System prompt mentioning "deep sleep consolidation" and "synthesize cross-category connections"
      - User message with numbered MEMORIES TO MERGE section (content, category, importance)
      - CONNECTIONS section listing relation types between cluster members
      - JSON response format instruction
      - temperature: 0.1, maxTokens: 500

    nremConsolidate(memories, getRelations, provider, options?):
    - Calls findFusionClusters with NREM config (minProm 0.05, maxProm 0.8, crossCategory true, maxClusters 10)
    - For each cluster: builds relation context, calls enhanced fusion
    - Returns NremResult: { clustersProcessed, fusionResults: FusionResult[], failures }
    - Each FusionResult includes learnedFrom: 'nrem_consolidation' marker
    - Per-cluster error isolation: one cluster failure doesn't stop others
    - Empty memories → { clustersProcessed: 0, fusionResults: [], failures: 0 }
    - LLM failure for all clusters → failures count matches cluster count, fusionResults empty
  </behavior>
  <implementation>
    1. Create src/memory/nrem-consolidation.ts following pure function pattern from fusion.ts
    2. Define NremConfig interface (minProminence, maxProminence, maxClusters, minClusterSize, maxRelationsPerMemory)
    3. Define DEFAULT_NREM_CONFIG: { minProminence: 0.05, maxProminence: 0.8, maxClusters: 10, minClusterSize: 3, maxRelationsPerMemory: 3 }
    4. Implement buildRelationContext() — iterate cluster, fetch relations, filter to intra-cluster, cap per memory
    5. Implement buildNremFusionPrompt() — extends buildFusionPrompt pattern with relation context section
    6. Implement nremConsolidate() — orchestrates findFusionClusters (crossCategory: true) → buildRelationContext → LLM fusion per cluster
    7. For cross-category clusters (>1 distinct category), override result category to 'insight'
    8. Export all types and functions, plus buildNremFusionPrompt for testing (same pattern as buildFusionPrompt)
  </implementation>
</feature>

<verification>
npm test -- src/memory/nrem-consolidation.test.ts
</verification>

<success_criteria>
- nrem-consolidation.ts created with pure functions (no DB injection)
- buildRelationContext correctly filters to intra-cluster relations and caps per memory
- buildNremFusionPrompt includes CONNECTIONS section in prompt
- nremConsolidate orchestrates the pipeline with per-cluster error isolation
- Cross-category clusters produce `insight` category in FusionResult
- All functions exported, all types exported
- 2-3 TDD commits
</success_criteria>

<output>
After completion, create `.planning/phases/27-dream-nrem-consolidation/27-02-SUMMARY.md`
</output>
