---
phase: 27-dream-nrem-consolidation
plan: 01
type: tdd
---

<objective>
Add `crossCategory` flag to `FusionConfig` and `findFusionClusters()` so NREM consolidation can discover cross-category clusters while deep-tick fusion continues with same-category-only behavior.

Purpose: The existing `findFusionClusters()` always splits BFS components by category (lines 131-147 of fusion.ts). NREM needs cross-category clusters to discover deeper conceptual threads (e.g., "interest in Rust" fact + "frustration with Node.js" event = migration intent insight). Adding a `crossCategory` flag with `false` default preserves existing behavior while enabling NREM's wider scope.

Output: Extended `FusionConfig` interface with `crossCategory` field, updated `findFusionClusters()` that conditionally skips category splitting, full TDD test coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-dream-nrem-consolidation/27-RESEARCH.md

# Key source files:
@src/memory/fusion.ts
@src/memory/fusion.test.ts
@src/memory/decay.ts

# Prior phase summaries (dependency chain):
@.planning/phases/21-memory-fusion-engine/21-01-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-05-SUMMARY.md

**Established patterns:**
- Pure functions with data + callbacks (no DB injection) — fusion.ts pattern
- BFS cluster detection with `getRelations` callback
- Category boundary splitting at lines 131-147 of fusion.ts
- `FusionConfig` with `Partial<FusionConfig>` override pattern

**Constraining decisions:**
- Phase 21: `findFusionClusters()` splits components by category (anti-pattern: cross-category fusion producing incoherent summaries)
- Phase 27 RESEARCH.md: Cross-category is safe during NREM because relation context enrichment explains connections; BFS already enforces semantic coherence via relation graph

**RESEARCH.md Don't Hand-Roll:**
- BFS cluster detection — reuse `findFusionClusters()` with config override
- Prominence filtering — already configurable via minProminence/maxProminence
</context>

<feature>
  <name>Cross-category fusion clustering</name>
  <files>src/memory/fusion.ts, src/memory/fusion.test.ts</files>
  <behavior>
    findFusionClusters() with crossCategory: false (default):
    - Existing behavior: splits BFS components by category into sub-clusters
    - Input: 6 memories (3 facts + 3 preferences) all connected by relations
    - Expected: 2 clusters (3 facts, 3 preferences) — same as current behavior
    - All existing tests continue to pass unchanged

    findFusionClusters() with crossCategory: true:
    - Input: 6 memories (3 facts + 3 preferences) all connected by relations
    - Expected: 1 cluster of 6 (no category split)
    - Input: 4 memories (2 facts + 2 events) in same BFS component
    - Expected: 1 cluster of 4

    Edge cases:
    - crossCategory: true with disconnected components → separate clusters (BFS boundary respected)
    - crossCategory: true with cluster below minClusterSize after filtering → excluded
    - crossCategory: undefined → defaults to false (backward compatible)
  </behavior>
  <implementation>
    1. Add `crossCategory?: boolean` to FusionConfig interface (default false in DEFAULT_FUSION_CONFIG)
    2. In findFusionClusters(), after BFS finds connected components (line 129), conditionally skip the category split loop (lines 131-147):
       - If config.crossCategory is true: use components directly as clusters (skip category split)
       - If config.crossCategory is false (default): run existing category split logic
    3. Rest of pipeline unchanged (minClusterSize filter, sort by size, cap at maxClusters)
  </implementation>
</feature>

<verification>
npm test -- src/memory/fusion.test.ts
</verification>

<success_criteria>
- FusionConfig has `crossCategory?: boolean` field
- findFusionClusters() respects crossCategory flag
- crossCategory: false (default) produces identical behavior to current — all existing tests pass
- crossCategory: true returns cross-category clusters from single BFS components
- Edge cases tested (disconnected components, small clusters, undefined flag)
- 2-3 TDD commits (test → feat → refactor if needed)
</success_criteria>

<output>
After completion, create `.planning/phases/27-dream-nrem-consolidation/27-01-SUMMARY.md`
</output>
