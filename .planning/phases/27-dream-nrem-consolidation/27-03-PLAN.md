---
phase: 27-dream-nrem-consolidation
plan: 03
type: execute
---

<objective>
Wire NREM consolidation into BackgroundGardener's `sleepTick()` and add integration tests proving the full sleep-tick → NREM → fused-memory pipeline works end-to-end.

Purpose: The NREM pure functions (from 27-01 and 27-02) need to be integrated into the gardener's Tier 3 sleep tick. This follows the exact same wiring pattern used in Phase 21-02 (fusion wired into deepTick). The integration test proves that when sleepTick fires, NREM consolidation runs, fused memories are stored, sources are superseded, and DERIVES relations are created.

Output: Working sleepTick with NREM consolidation, integration tests, all NREM exports from memory/index.ts, Phase 27 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-dream-nrem-consolidation/27-RESEARCH.md
@.planning/phases/27-dream-nrem-consolidation/27-01-SUMMARY.md
@.planning/phases/27-dream-nrem-consolidation/27-02-SUMMARY.md

# Key source files:
@src/memory/memory.ts
@src/memory/fusion.ts
@src/memory/nrem-consolidation.ts
@src/memory/index.ts
@src/memory/db.ts
@src/memory/scallop-store.ts
@src/gateway/gateway.ts
@src/memory/gardener-tier3.test.ts
@src/memory/gardener-integration.test.ts

# Prior phase summaries (wiring pattern reference):
@.planning/phases/21-memory-fusion-engine/21-02-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-04-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-05-SUMMARY.md

**Established patterns:**
- deepTick fusion wiring at memory.ts:176-261 — exact pattern to follow for sleepTick
- try-catch per operation in deepTick (per-step error isolation)
- fusionProvider opt-in injection via BackgroundGardener constructor
- Fused memory storage: store.add() → updateMemory(derived) → addRelation(DERIVES) → supersede sources → set prominence
- dynamic import for cross-module deps (Phase 25-03 pattern)
- Integration tests: gardener-integration.test.ts pattern with mock providers

**Constraining decisions:**
- Phase 24-05: sleepTick() is public async, fires at SLEEP_EVERY=288 during quiet hours
- Phase 21-02: fusionProvider reuses rerankProvider (fast-tier LLM) — NREM should reuse same provider
- Phase 27 RESEARCH: Use `learnedFrom: 'nrem_consolidation'` to distinguish from daytime fusion
- Phase 27 RESEARCH: NREM prominence window [0.05, 0.8), maxClusters 10 (higher budget than daytime)
- Phase 27 RESEARCH: Fused memory prominence = min(0.6, maxSourceProminence + 0.1) — same as deep tick
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire NREM into sleepTick and export from index.ts</name>
  <files>src/memory/memory.ts, src/memory/index.ts</files>
  <action>
    Replace the sleepTick() placeholder (memory.ts:436-443) with NREM consolidation logic. Follow the EXACT pattern from deep-tick fusion (memory.ts:176-261):

    1. In sleepTick(), check if this.fusionProvider exists (same guard as deep tick)
    2. Get distinct user IDs (same query as deep tick: `SELECT DISTINCT user_id FROM memories WHERE source != '_cleaned_sentinel'`)
    3. For each user:
       a. Get memories with `getMemoriesByUser(userId, { minProminence: 0.05, isLatest: true, includeAllSources: true })`
       b. Filter in JS: prominence < 0.8 AND memoryType !== 'static_profile' AND memoryType !== 'derived' (NREM's wider window)
       c. Skip if < 3 eligible memories
       d. Call `nremConsolidate(eligibleMemories, (id) => db.getRelations(id), this.fusionProvider)` from nrem-consolidation.ts
       e. For each successful FusionResult in the NremResult:
          - Store via store.add() with learnedFrom: 'nrem_consolidation', metadata: { fusedAt, sourceCount, sourceIds, nrem: true }
          - Override memoryType to 'derived' via updateMemory()
          - Add DERIVES relations to source memories
          - Mark sources as superseded (isLatest: false, memoryType: 'superseded')
          - Set fused prominence = min(0.6, maxSourceProminence + 0.1)
    4. Log results: { userId, clustersProcessed, memoriesConsolidated, failures }
    5. Wrap entire NREM block in try/catch (same pattern as deep tick fusion block)
    6. Keep Phase 28/30 placeholder comments after the NREM block

    NOTE: The nremConsolidate() function returns FusionResult[] — the STORAGE of fused memories happens here in sleepTick (same as deep tick), NOT in the pure function. The pure function only computes the fusion; the caller handles persistence.

    In index.ts, add exports for the nrem-consolidation module:
    - nremConsolidate, buildNremFusionPrompt, buildRelationContext, DEFAULT_NREM_CONFIG
    - NremConfig, NremResult, RelationContextEntry types

    Import nrem-consolidation.ts using the same pattern as fusion.ts import.
  </action>
  <verify>npm run build (TypeScript compiles without errors)</verify>
  <done>sleepTick() calls nremConsolidate() and stores results following deep-tick pattern. All NREM types and functions exported from memory/index.ts. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Add NREM sleep-tick integration tests</name>
  <files>src/memory/gardener-nrem.test.ts</files>
  <action>
    Create integration tests following the pattern from gardener-integration.test.ts and gardener-tier3.test.ts. Use Vitest with describe/it/expect/vi.

    Test cases:

    1. "sleepTick runs NREM consolidation when fusionProvider available"
       - Setup: Create BackgroundGardener with mock fusionProvider
       - Insert 4+ memories with prominence in [0.05, 0.8) across 2 categories (e.g., 2 facts + 2 preferences)
       - Add relations between them (so BFS finds a connected component)
       - Mock fusionProvider.complete() to return valid JSON: { summary, importance, category }
       - Call sleepTick()
       - Assert: new 'derived' memory exists, sources marked superseded, DERIVES relations created

    2. "sleepTick skips NREM when no fusionProvider"
       - Setup: BackgroundGardener without fusionProvider
       - Call sleepTick()
       - Assert: no errors, no memory changes

    3. "sleepTick NREM uses wider prominence window than deepTick"
       - Setup: Insert memories at prominence 0.06 (below deep-tick's 0.1 floor but within NREM's 0.05)
       - Insert memories at prominence 0.75 (above deep-tick's 0.7 cap but within NREM's 0.8)
       - Call sleepTick()
       - Assert: these memories ARE included in NREM clusters (they would be excluded from deep-tick fusion)

    4. "sleepTick NREM produces cross-category clusters"
       - Setup: Insert 3 facts + 2 preferences with relations connecting them
       - Mock fusionProvider to return result
       - Call sleepTick()
       - Assert: fused memory created from cross-category cluster (sources span both categories)

    5. "sleepTick NREM isolates per-cluster errors"
       - Setup: Insert two separate clusters (disconnected)
       - Mock fusionProvider: first call throws, second returns valid result
       - Call sleepTick()
       - Assert: second cluster still fused successfully despite first failure

    Use mock patterns from existing test files:
    - createMockProvider from testing conventions
    - ScallopDatabase in-memory for actual DB operations
    - Actual ScallopMemoryStore with mock embedder

    DO NOT test nremConsolidate() pure function behavior here — that's covered in 27-02's TDD tests. These integration tests verify the WIRING: sleepTick → nremConsolidate → storage → relations → supersession.
  </action>
  <verify>npm test -- src/memory/gardener-nrem.test.ts</verify>
  <done>All 5 integration tests pass. NREM consolidation correctly wired into sleepTick with proper storage, relations, supersession, and error isolation.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test -- src/memory/fusion.test.ts` passes (existing + new cross-category tests from 27-01)
- [ ] `npm test -- src/memory/nrem-consolidation.test.ts` passes (27-02 TDD tests)
- [ ] `npm test -- src/memory/gardener-nrem.test.ts` passes (integration tests)
- [ ] `npm test` passes all tests (no regressions)
- [ ] sleepTick() is no longer a no-op placeholder
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- sleepTick() runs NREM consolidation with wider window, cross-category, relation context
- Fused memories stored with learnedFrom: 'nrem_consolidation'
- Sources superseded with DERIVES relations
- Error isolation: one cluster failure doesn't stop others
- All NREM types and functions exported from memory/index.ts
- No regressions in existing fusion or gardener tests
- Phase 27 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/27-dream-nrem-consolidation/27-03-SUMMARY.md`:

# Phase 27 Plan 03: Wire NREM into sleepTick Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Phase 27 complete, ready for Phase 28: Dream REM Exploration.

Update STATE.md:
- Current position: Phase 27 complete
- Add to v4.0 decisions: NREM uses fusionProvider (same as deep-tick), learnedFrom 'nrem_consolidation', prominence window [0.05, 0.8), cross-category enabled

Update ROADMAP.md:
- Mark Phase 27 plans as complete: [x] 27-01, [x] 27-02, [x] 27-03
- Update progress table
</output>
