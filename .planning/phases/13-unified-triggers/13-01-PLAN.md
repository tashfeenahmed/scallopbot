---
phase: 13-unified-triggers
plan: 01
type: execute
---

<objective>
Unify trigger sources so Telegram, Web UI, and Cron can all initiate agent conversations through a common abstraction.

Purpose: Currently reminder callbacks hardcode Telegram channel. This decouples trigger handling from specific channels.
Output: TriggerSource interface and multi-channel trigger dispatch in Gateway.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-loop-until-done/12-01-SUMMARY.md
@.planning/phases/11-web-ui/11-01-SUMMARY.md

**Key files:**
@src/gateway/gateway.ts
@src/tools/reminder.ts
@src/scheduler/scheduler.ts
@src/channels/api.ts
@src/channels/telegram.ts

**Tech stack available:**
- TelegramChannel with sendMessage
- ApiChannel with WebSocket broadcast
- CronScheduler with job scheduling
- ReminderTool with recurring schedules

**Established patterns:**
- [DONE] marker for task completion
- Loop-until-done agent behavior
- Channel singleton pattern (TelegramGateway)

**Constraining decisions:**
- Phase 11: Static files served without auth, WebSocket with ping/pong heartbeat
- Phase 12: [DONE] marker signals task completion, backward compatible
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TriggerSource abstraction and multi-channel dispatch</name>
  <files>src/triggers/types.ts, src/triggers/index.ts, src/gateway/gateway.ts</files>
  <action>
Create a TriggerSource interface in src/triggers/types.ts:
- `sendMessage(userId: string, message: string): Promise<boolean>` - Send message to user
- `sendFile(userId: string, filePath: string, caption?: string): Promise<boolean>` - Send file
- `getName(): string` - Get trigger source name for logging

Create src/triggers/index.ts to export types.

In Gateway, refactor to maintain a Map<string, TriggerSource> of active trigger sources. When channels start:
- TelegramChannel implements TriggerSource (already has sendMessage/sendFile)
- ApiChannel needs sendMessage added (broadcast to connected WebSocket clients with matching userId)

Refactor handleReminderTrigger to:
1. Look up trigger source by channel (userId prefix like "telegram:" or "api:")
2. Fall back to first available trigger source if no prefix
3. Log which trigger source was used

Also refactor handleFileSend and handleMessageSend to use the trigger abstraction instead of hardcoding telegramChannel.

Keep existing behavior when only Telegram is configured (backward compatible).
  </action>
  <verify>TypeScript compiles without errors. Existing reminder tests still pass (if any).</verify>
  <done>TriggerSource interface exists, Gateway uses trigger abstraction for message/file sending, multi-channel dispatch works</done>
</task>

<task type="auto">
  <name>Task 2: Add message broadcast to ApiChannel for trigger support</name>
  <files>src/channels/api.ts</files>
  <action>
Extend ApiChannel to support sending messages to connected WebSocket clients:

1. Track connected WebSocket clients by userId in a Map<string, Set<WebSocket>>
2. On WebSocket connect, associate client with userId (from initial message or session)
3. Add `sendMessage(userId: string, message: string): Promise<boolean>` method:
   - Find all WebSocket connections for userId
   - Send JSON message `{ type: 'trigger', content: message }` to each
   - Return true if at least one message sent

4. Add `sendFile(userId: string, filePath: string, caption?: string): Promise<boolean>`:
   - For WebSocket, send `{ type: 'file', path: filePath, caption }` (client handles download)
   - Return true if sent

5. Add `getName(): string` returning 'api'

6. Make ApiChannel implement TriggerSource interface

Update the WebSocket message handler to extract userId from session (use ws-{clientId} pattern already in place).
  </action>
  <verify>npm run build passes. Manual test: Connect via WebSocket, trigger a reminder, verify message arrives on WebSocket client.</verify>
  <done>ApiChannel implements TriggerSource, can broadcast messages to connected WebSocket clients by userId</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] TypeScript types are correct (no any escapes)
- [ ] Existing tests pass (`npm test`)
- [ ] Reminders still work when only Telegram is configured (backward compat)
</verification>

<success_criteria>

- TriggerSource interface defined
- Gateway maintains registry of trigger sources
- Reminder triggers route to correct channel based on userId
- ApiChannel can send messages via WebSocket
- Backward compatible with Telegram-only setup
</success_criteria>

<output>
After completion, create `.planning/phases/13-unified-triggers/13-01-SUMMARY.md`
</output>
