---
phase: 13-unified-triggers
plan: 02
type: execute
---

<objective>
Add cron scheduling skill so users can schedule agent-triggered jobs from conversation.

Purpose: Enable users to set up recurring agent tasks like "check the weather every morning at 8am" through natural conversation.
Output: cron skill for scheduling, CronScheduler wired into Gateway with agent execution capability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-unified-triggers/13-01-SUMMARY.md (will exist after Plan 01)

**Key files:**
@src/scheduler/scheduler.ts
@src/gateway/gateway.ts
@src/skills/bundled/bash/SKILL.md (pattern for skill structure)
@src/tools/reminder.ts (similar scheduling patterns)

**Tech stack available:**
- CronScheduler with job scheduling, pause/resume, history
- TriggerSource abstraction (from Plan 01)
- SkillExecutor for running skill scripts

**Established patterns:**
- Skill folder structure: SKILL.md + scripts/run.ts
- YAML frontmatter for skill metadata
- Agent loops until [DONE] marker

**Constraining decisions:**
- Plan 01: TriggerSource abstraction for multi-channel message dispatch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire CronScheduler into Gateway with agent execution</name>
  <files>src/gateway/gateway.ts, src/scheduler/scheduler.ts</files>
  <action>
In Gateway.initialize():
1. Create CronScheduler instance
2. Register a notifier for each trigger source channel

In Gateway.start():
1. Start the CronScheduler

In Gateway.stop():
1. Stop the CronScheduler

Add a new action type 'agent' to CronScheduler that:
- Takes a prompt string in action.config
- Takes a userId and sessionId in action.config
- Executes the prompt through the Agent
- Sends the result via the appropriate TriggerSource

In scheduler.ts:
1. Add 'agent' to BuiltInActionType union
2. Add BuiltInActions.agent that accepts context with agent, prompt, userId, sessionId, triggerSource
3. Agent action runs prompt through agent and sends result via triggerSource

This enables jobs like:
```typescript
scheduler.schedule({
  name: 'morning-weather',
  cron: '0 8 * * *',
  action: {
    type: 'agent',
    config: {
      prompt: 'Check the weather for today',
      userId: 'telegram:123',
      sessionId: 'weather-session',
    }
  }
});
```
  </action>
  <verify>TypeScript compiles. Manual test: Schedule a job with agent action, verify it triggers and sends response.</verify>
  <done>CronScheduler wired into Gateway lifecycle, agent action type executes prompts through Agent</done>
</task>

<task type="auto">
  <name>Task 2: Create cron skill for scheduling via conversation</name>
  <files>src/skills/bundled/cron/SKILL.md, src/skills/bundled/cron/scripts/run.ts</files>
  <action>
Create SKILL.md with:
```yaml
name: cron
description: Schedule recurring tasks using cron expressions
triggers:
  - schedule
  - every day at
  - recurring
  - cron
user-invocable: false
inputSchema:
  type: object
  properties:
    action:
      type: string
      enum: [schedule, list, cancel, pause, resume]
      description: Action to perform
    name:
      type: string
      description: Job name (for schedule action)
    cron:
      type: string
      description: Cron expression or shorthand (@daily, @hourly)
    prompt:
      type: string
      description: What the agent should do when triggered
    job_id:
      type: string
      description: Job ID (for cancel/pause/resume)
  required: [action]
```

Create run.ts script that:
1. Parses SKILL_ARGS for action, name, cron, prompt, job_id
2. Uses the existing scheduler singleton (needs Gateway to expose it)
3. For 'schedule': Creates job with agent action type, returns job ID and next run time
4. For 'list': Returns all jobs with status, next run, last run
5. For 'cancel': Removes job by ID
6. For 'pause'/'resume': Pauses/resumes job

Gateway needs to expose scheduler for skill access - add SchedulerGateway singleton pattern (similar to TelegramGateway).

Script outputs JSON result for agent to interpret.
  </action>
  <verify>npm run build passes. Skill appears in skill registry. Manual test: Use cron skill to schedule a job.</verify>
  <done>cron skill exists and can schedule/list/cancel/pause/resume jobs via conversation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] cron skill loads in skill registry
- [ ] Existing tests pass (`npm test`)
- [ ] Manual test: Schedule a cron job, verify it executes at scheduled time
</verification>

<success_criteria>

- CronScheduler integrated with Gateway lifecycle
- Agent action type enables executing prompts on schedule
- cron skill allows conversational job management
- Jobs can be scheduled, listed, cancelled, paused, resumed
- Phase 13 complete: Telegram, Web UI, and Cron unified as trigger sources
</success_criteria>

<output>
After completion, create `.planning/phases/13-unified-triggers/13-02-SUMMARY.md`
</output>
