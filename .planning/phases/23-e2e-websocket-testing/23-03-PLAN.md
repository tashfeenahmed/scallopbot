---
phase: 23-e2e-websocket-testing
plan: 03
type: execute
---

<objective>
Validate memory fusion and behavioral profiling features end-to-end, then run a full multi-turn conversation flow that exercises all v3.0 features together.

Purpose: Prove that the BackgroundGardener's deep tick correctly fuses dormant memories and computes behavioral signals, and that a realistic multi-turn conversation triggers the complete v3.0 pipeline.
Output: E2E tests for fusion, behavioral profiling, and a comprehensive integration scenario. Phase 23 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/23-e2e-websocket-testing/23-01-SUMMARY.md
@.planning/phases/23-e2e-websocket-testing/23-02-SUMMARY.md

# v3.0 feature summaries:
@.planning/phases/21-memory-fusion-engine/21-01-SUMMARY.md
@.planning/phases/21-memory-fusion-engine/21-02-SUMMARY.md
@.planning/phases/22-behavioral-profiling/22-01-SUMMARY.md
@.planning/phases/22-behavioral-profiling/22-02-SUMMARY.md

# Key source files:
@src/e2e/helpers.ts
@src/memory/memory.ts
@src/memory/fusion.ts
@src/memory/behavioral-signals.ts
@src/memory/profiles.ts
@src/memory/db.ts

**Tech stack available:** Vitest, better-sqlite3, ws
**Established patterns:** E2E helpers from 23-01, DB assertions from 23-02
**Constraining decisions:**
- [Phase 21]: maxProminence 0.7 for fusion candidates, findFusionClusters BFS with category boundaries, graceful null on LLM failure
- [Phase 22]: EMA halfLife 7 days, topic switch threshold 0.3, _sig_ prefix keys in response_preferences JSON, cold start null for < 10 messages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Memory fusion and behavioral profiling E2E tests</name>
  <files>src/e2e/memory-lifecycle.test.ts</files>
  <action>
Create a new E2E test file for memory lifecycle features.

**Test: Deep tick fuses dormant related memories**

Setup:
- Seed the test DB with a cluster of related dormant memories (prominence < 0.7):
  - Memory A: "User mentioned liking coffee" (prominence: 0.3)
  - Memory B: "User drinks coffee every morning" (prominence: 0.25)
  - Memory C: "User prefers dark roast" (prominence: 0.2)
  - All connected by EXTENDS relations
  - All same category ('preference') and same userId
- Configure the mock fusionProvider to return a coherent merged summary when called (e.g., "User is an avid coffee drinker who prefers dark roast and has coffee every morning")

Test:
- Trigger a deep tick on the BackgroundGardener programmatically (call deepTick() directly rather than waiting 6 hours)
- After deep tick completes, query the DB:
  - Assert a new 'derived' memory exists containing the fused summary
  - Assert original memories are marked `memoryType: 'superseded'` and `isLatest: false`
  - Assert DERIVES relations exist from fused memory to each source
  - Assert fused memory prominence is <= 0.7 (maxProminence cap)

**Test: Behavioral signals computed after sufficient messages**

Setup:
- Seed the test DB with 15+ session messages (to exceed the cold-start threshold of 10):
  - Spread across 3+ sessions
  - Varying timestamps over past 14 days
  - Include embeddings (from mock embedder) for topic switch detection
- Seed 3+ sessions with message counts and durations

Test:
- Trigger deepTick() on BackgroundGardener (which calls inferBehavioralPatterns internally)
- Query `behavioral_patterns` table (or the user_profiles with response_preferences JSON):
  - Assert messageFrequency signal is non-null (dailyRate > 0)
  - Assert sessionEngagement signal is non-null
  - Assert topicSwitchRate signal is non-null (if embeddings provided)
  - Assert responseLengthEvolution signal is non-null

**Test: Behavioral signals format in profile context**

After signals are computed:
- Call `formatProfileContext()` on the ProfileManager for the test user
- Assert the returned string includes natural-language behavioral insights (e.g., contains "messaging pace" or "session" or "topic")
- Assert it does NOT contain raw numbers or _sig_ keys (those are internal)

**Key:** For these tests, we don't need the full gateway + WebSocket. Access BackgroundGardener and ProfileManager directly from the gateway instance (or construct them with the test DB). The helpers from 23-01 should provide access to these components.

Avoid: Testing exact EMA calculations (unit tested in 22-01). Focus on: do signals get computed and stored when sufficient data exists? Does deep tick trigger fusion correctly?
  </action>
  <verify>npx vitest run src/e2e/memory-lifecycle.test.ts (all 3 tests pass)</verify>
  <done>3 E2E tests pass: fusion merges dormant memories, behavioral signals computed from session data, profile context includes natural-language insights.</done>
</task>

<task type="auto">
  <name>Task 2: Full multi-turn conversation E2E test</name>
  <files>src/e2e/full-flow.test.ts</files>
  <action>
Create a comprehensive E2E test that simulates a realistic multi-turn conversation exercising all v3.0 features together.

**Test: Multi-turn conversation with memory operations**

This is the "smoke test" that validates the complete pipeline:

1. **Turn 1 — Establish facts:** Send "Hi, I'm Bob. I work as a data scientist at Meta and I love hiking."
   - Wait for response
   - Verify: memories stored (fact extraction happened)
   - Verify: session created in DB

2. **Turn 2 — Add related facts:** Send "I recently moved to Boulder, Colorado for the hiking trails."
   - Wait for response
   - Verify: new memories stored
   - Verify: if relations are classified, a relation exists between "lives in Boulder" and "loves hiking" (or between job/location facts)

3. **Turn 3 — Trigger memory retrieval:** Send "What do you know about my hobbies?"
   - Collect all WS messages
   - Verify: `{ type: 'memory' }` message received (search triggered)
   - Verify: response references hiking (from Turn 1)
   - If spreading activation is active: related location memories may also surface

4. **Turn 4 — Test session continuity:** Send "And what's my job?" (in same session)
   - Verify: response references data scientist / Meta
   - This proves session context and memory search work together

After all turns:
- Query DB to verify:
  - Multiple memories exist for the user
  - Session has 4+ messages
  - If re-ranking was active: access counts on relevant memories > 0
  - Memory relations exist (if LLM classifier ran)

**Mock LLM considerations:**
The mock provider needs to handle multiple types of calls:
- Agent completion (returns conversational text + [DONE])
- Fact extraction (returns structured facts)
- Re-ranking (returns relevance scores)
- Relation classification (returns relation types)

Either use a single mock that detects the call type from the prompt/system message and returns appropriate responses, or configure multiple mock providers for different roles (the gateway assigns different providers for different tasks).

Study how gateway.ts assigns providers to roles (main agent provider vs. rerankProvider vs. classifierProvider vs. fusionProvider) — each can be independently mocked.

**Test timeout:** 60s (multi-turn E2E with real SQLite operations).

Avoid: Asserting exact response text (LLM responses are mocked but agent may format differently). Assert on structure: response exists, memories stored, relations created. Avoid flakiness: use waitForResponse with generous timeouts between turns.
  </action>
  <verify>npx vitest run src/e2e/full-flow.test.ts (test passes)</verify>
  <done>Multi-turn E2E test passes: 4-turn conversation stores memories, creates relations, retrieves via search with re-ranking, maintains session continuity.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx vitest run src/e2e/` passes ALL tests across all E2E files
- [ ] No TypeScript compilation errors
- [ ] All test databases cleaned up
- [ ] Tests complete within 120s total
- [ ] No leftover processes or port conflicts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Memory fusion verified end-to-end (dormant → fused → superseded)
- Behavioral profiling verified (signals computed, formatted as natural language)
- Full multi-turn conversation exercises complete v3.0 pipeline
- Phase 23 complete — v3.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/23-e2e-websocket-testing/23-03-SUMMARY.md`
</output>
