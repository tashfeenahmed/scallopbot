---
phase: 28-dream-rem-exploration
plan: 01
type: tdd
---

<objective>
Implement the REM exploration module — stochastic seed sampling, high-noise spreading activation for neighbor discovery, and LLM-judge connection validation.

Purpose: Create the core REM exploration engine that discovers novel cross-memory connections through graph exploration with elevated noise, following the pure-function pattern established by nrem-consolidation.ts.
Output: Working, tested rem-exploration.ts with sampleSeeds, remExplore, and buildConnectionJudgePrompt.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-dream-rem-exploration/28-RESEARCH.md

# Key source files (follow these patterns):
@src/memory/nrem-consolidation.ts
@src/memory/relations.ts
@src/memory/fusion.ts
@src/memory/db.ts

**Tech stack available:** Vitest, spreadActivation, gaussianNoise, EDGE_WEIGHTS, findFusionClusters, LLMProvider, ScallopMemoryEntry, MemoryRelation
**Established patterns:** Pure functions with getRelations callback, LLMProvider as argument, per-item error isolation, JSON-only LLM prompts with structured parsing
**Constraining decisions:**
- Phase 27: Pure function architecture (no DB access in consolidation modules)
- Phase 27: learnedFrom field distinguishes consolidation sources
- Phase 20: spreadActivation with configurable noiseSigma, gaussianNoise Box-Muller
- RESEARCH.md: noiseSigma 0.5-0.8 for REM (default 0.6), EXTENDS relations only, max 5-8 seeds, LLM judge with novelty/plausibility/usefulness scoring
- RESEARCH.md: Don't hand-roll graph traversal or noise — use existing spreadActivation + gaussianNoise
</context>

<feature>
  <name>REM Exploration Module</name>
  <files>src/memory/rem-exploration.ts, src/memory/rem-exploration.test.ts</files>
  <behavior>
    Types:
    - RemConfig: { noiseSigma (0.6), maxSeeds (6), maxCandidatesPerSeed (8), seedNoiseSigma (0.3), maxSeedsPerCategory (2), maxSteps (4), decayFactor (0.4), resultThreshold (0.02), activationThreshold (0.005), minJudgeScore (3.0), prominenceWindow: { min (0.05), max (0.8) } }
    - RemDiscovery: { seedId, neighborId, connectionDescription, confidence, noveltyScore, plausibilityScore, usefulnessScore }
    - RemExplorationResult: { seedsExplored, candidatesEvaluated, discoveries: RemDiscovery[], failures }

    sampleSeeds(memories, config) → ScallopMemoryEntry[]:
    - Input: eligible memories array, partial RemConfig
    - Weight each by importance × prominence × (1 + gaussianNoise(seedNoiseSigma))
    - Sort descending, take top-K with category diversity (max maxSeedsPerCategory per category)
    - Returns up to maxSeeds memories from diverse categories
    - Empty input → empty array
    - All same category → capped at maxSeedsPerCategory

    buildConnectionJudgePrompt(seed, neighbor, existingRelations) → CompletionRequest:
    - System prompt: memory connection evaluator during creative exploration
    - User message includes full content of seed and neighbor, plus any existing relations
    - Requests JSON with novelty (1-5), plausibility (1-5), usefulness (1-5)
    - If avg >= minJudgeScore: include connection description + confidence
    - Otherwise: NO_CONNECTION
    - temperature: 0.3 (slightly creative for connection description)

    parseJudgeResponse(text) → { novelty, plausibility, usefulness, connection?, confidence? } | null:
    - Parse JSON from LLM response
    - Handle NO_CONNECTION case
    - Return null on parse failure (graceful)

    remExplore(memories, getRelations, llmProvider, config?) → RemExplorationResult:
    - Filter memories by prominenceWindow
    - Call sampleSeeds to select diverse seeds
    - For each seed: spreadActivation with REM noise config (noiseSigma, maxSteps, etc.)
    - Filter out neighbors that already have direct relations with seed
    - For each remaining candidate: buildConnectionJudgePrompt → LLM → parseJudgeResponse
    - Collect RemDiscovery for accepted connections (avg score >= minJudgeScore)
    - Per-seed error isolation (try/catch, increment failures)
    - Return RemExplorationResult with totals

    Edge cases:
    - No eligible memories → { seedsExplored: 0, candidatesEvaluated: 0, discoveries: [], failures: 0 }
    - No candidates after filtering known relations → seed skipped, no LLM call
    - LLM returns unparseable response → failure incremented, continue
    - All candidates rejected by judge → discoveries empty (valid outcome)
  </behavior>
  <implementation>
    Create src/memory/rem-exploration.ts following nrem-consolidation.ts pattern exactly:
    - Import types from db.ts, providers/types.ts
    - Import spreadActivation, gaussianNoise from relations.ts (NOT from relations.js — use .js extension per project convention)
    - Pure functions only — no DB access, no class, no constructor
    - Export DEFAULT_REM_CONFIG, sampleSeeds, buildConnectionJudgePrompt, parseJudgeResponse, remExplore
    - LLM response parsing follows parseFusionResponse pattern (JSON extraction via regex)
    - Relation filtering: for each seed+neighbor pair, check getRelations(seed.id) and getRelations(neighbor.id) for any direct link
  </implementation>
</feature>

<verification>
npm test -- src/memory/rem-exploration.test.ts
All tests pass, covering: seed sampling (diversity, weighting, edge cases), prompt construction, response parsing (valid, invalid, NO_CONNECTION), full explore pipeline (mock LLM), relation pre-filtering, per-seed error isolation
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- rem-exploration.ts passes all tests (GREEN)
- Refactor if needed (REFACTOR)
- sampleSeeds provides category-diverse seed selection
- buildConnectionJudgePrompt produces structured LLM request
- parseJudgeResponse handles all response formats gracefully
- remExplore orchestrates full pipeline with error isolation
- No hand-rolled graph traversal — uses existing spreadActivation
- noiseSigma defaults to 0.6 (within researched 0.5-0.8 range)
</success_criteria>

<output>
After completion, create `.planning/phases/28-dream-rem-exploration/28-01-SUMMARY.md`
</output>
