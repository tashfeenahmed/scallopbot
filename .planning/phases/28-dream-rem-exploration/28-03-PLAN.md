---
phase: 28-dream-rem-exploration
plan: 03
type: execute
---

<objective>
Wire the dream orchestrator into sleepTick, replacing the inline NREM code and Phase 28 placeholder with the unified dream() call. Add REM result storage (EXTENDS relations), update index.ts exports.

Purpose: Complete the Phase 28 integration so the nightly sleep tick runs the full NREM→REM dream cycle. REM discoveries create EXTENDS relations between distant memories without modifying or superseding existing memories.
Output: sleepTick calls dream(), stores REM results as EXTENDS relations, all existing tests pass, new integration tests verify REM wiring.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-dream-rem-exploration/28-RESEARCH.md
@.planning/phases/28-dream-rem-exploration/28-01-SUMMARY.md
@.planning/phases/28-dream-rem-exploration/28-02-SUMMARY.md

# Key source files:
@src/memory/memory.ts
@src/memory/index.ts
@src/memory/dream.ts
@src/memory/rem-exploration.ts
@src/memory/nrem-consolidation.ts
@src/memory/gardener-nrem.test.ts

**Tech stack available:** dream(), DreamResult, remExplore, RemDiscovery, nremConsolidate, BackgroundGardener, ScallopMemoryStore
**Established patterns:** sleepTick NREM storage pattern (lines 472-517 of memory.ts), per-result try/catch, DERIVES relations for NREM
**Constraining decisions:**
- RESEARCH.md: REM does NOT create new memories — only adds EXTENDS relations between existing memories
- RESEARCH.md: REM does NOT supersede or modify existing memories (unlike NREM)
- RESEARCH.md: Store connection description in relation metadata (future use)
- Phase 27: sleepTick inline NREM code at lines 442-535 of memory.ts
- Phase 27: gardener-nrem.test.ts pattern for integration testing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sleepTick inline NREM with dream() orchestrator + REM storage</name>
  <files>src/memory/memory.ts</files>
  <action>
    Refactor sleepTick() in memory.ts:

    1. Add dynamic import for dream at the top of sleepTick (same pattern as nremConsolidate import — dynamic import to avoid circular deps if needed, or static import if nrem-consolidation.ts is already statically imported):
       - Import dream from './dream.js'
       - Import DreamResult, RemDiscovery types

    2. Replace the existing NREM block (lines ~442-535) with a unified dream() call:
       - Keep the same per-user loop and memory filtering logic
       - Call dream(eligibleMemories, getRelations, fusionProvider, fusionProvider) — same provider for both NREM and REM (fusionProvider is the fast-tier provider)
       - Handle DreamResult: store NREM results exactly as before (preserve existing behavior), then store REM results

    3. Add REM result storage after NREM storage:
       - For each discovery in result.rem.discoveries:
         - Add EXTENDS relation between discovery.seedId and discovery.neighborId
         - Confidence from discovery.confidence
         - Log the discovery (debug level)
       - Do NOT create new memories for REM (unlike NREM which creates derived memories)
       - Do NOT mark anything as superseded (REM is additive, not destructive)
       - Track REM stats: totalDiscoveries count

    4. Update logging:
       - Keep existing NREM logging
       - Add REM logging: discoveries count, seeds explored, candidates evaluated
       - Update final "Sleep tick complete" log to include both NREM and REM stats

    5. Keep Phase 30 placeholder comment after the dream cycle

    CRITICAL: The NREM storage logic must remain EXACTLY the same (same supersession, same DERIVES relations, same prominence setting). Only the call path changes (dream() → nremConsolidate internally instead of calling nremConsolidate directly).

    AVOID: Do not add a separate remProvider to BackgroundGardenerOptions — reuse fusionProvider for both NREM and REM (they use the same fast-tier LLM). This can be split later if needed.
  </action>
  <verify>npm test -- src/memory/gardener-nrem.test.ts — all existing NREM integration tests still pass (no regression from refactoring the call path)</verify>
  <done>sleepTick calls dream() instead of inline nremConsolidate, NREM behavior unchanged, REM discoveries stored as EXTENDS relations, Phase 30 placeholder preserved</done>
</task>

<task type="auto">
  <name>Task 2: Add REM integration tests and update exports</name>
  <files>src/memory/gardener-rem.test.ts, src/memory/index.ts</files>
  <action>
    1. Create src/memory/gardener-rem.test.ts following gardener-nrem.test.ts pattern:
       - Same mock setup: mock LLMProvider, mock EmbeddingProvider, ScallopMemoryStore with test DB
       - Initialize BackgroundGardener with fusionProvider

       Test cases:
       a. "sleepTick creates EXTENDS relations for REM discoveries":
          - Seed test memories across multiple categories with relations between some
          - Configure mock LLM to return valid judge responses for REM (JSON with novelty/plausibility/usefulness scores >= 3, connection description)
          - Call sleepTick()
          - Verify EXTENDS relations created between seed and neighbor memories
          - Verify no new memories created by REM (only relations)
          - Verify no memories superseded by REM

       b. "sleepTick REM runs after NREM without interference":
          - Seed memories that will trigger both NREM fusion and REM exploration
          - Mock LLM returns fusion responses for NREM, judge responses for REM
          - Call sleepTick()
          - Verify NREM fusions created (derived memories with DERIVES relations)
          - Verify REM discoveries created (EXTENDS relations only)
          - Both operate independently

       c. "sleepTick REM gracefully handles zero discoveries":
          - Seed memories with dense existing relations (all pairs already connected)
          - Or mock LLM to always return NO_CONNECTION
          - Call sleepTick()
          - Verify no errors, no EXTENDS created, NREM still works

       d. "sleepTick REM failure does not block NREM":
          - Mock LLM to succeed for NREM fusion calls, throw for REM judge calls
          - Call sleepTick()
          - Verify NREM results stored successfully
          - Verify no crash, graceful handling

    2. Update src/memory/index.ts exports:
       - Add dream.ts exports: dream, DreamConfig, DreamResult
       - Add rem-exploration.ts exports: remExplore, sampleSeeds, DEFAULT_REM_CONFIG, RemConfig, RemExplorationResult, RemDiscovery

    AVOID: Don't mock spreadActivation or gaussianNoise — let them run with their actual implementations. The mock boundary is only the LLMProvider (same as gardener-nrem.test.ts).
  </action>
  <verify>npm test -- src/memory/gardener-rem.test.ts — all REM integration tests pass. npm test -- src/memory/ — all memory module tests pass (no regressions).</verify>
  <done>Integration tests verify EXTENDS relations from REM, NREM unaffected, graceful failure, exports updated for dream + rem-exploration modules</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` — all tests pass (no regressions)
- [ ] `npm run build` or `npx tsc --noEmit` — no TypeScript errors
- [ ] sleepTick calls dream() orchestrator (not inline nremConsolidate)
- [ ] NREM behavior unchanged (existing gardener-nrem tests pass)
- [ ] REM discoveries stored as EXTENDS relations
- [ ] REM does NOT create new memories or supersede existing ones
- [ ] index.ts exports dream + rem-exploration types/functions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- sleepTick runs full NREM→REM dream cycle
- NREM behavior preserved exactly (no regression)
- REM adds EXTENDS relations for novel discoveries
- dream.ts and rem-exploration.ts exported from index.ts
- Phase 28 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/28-dream-rem-exploration/28-03-SUMMARY.md`:

# Phase 28 Plan 3: Wire REM into sleepTick Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/memory/memory.ts` - sleepTick refactored to use dream() orchestrator
- `src/memory/gardener-rem.test.ts` - REM integration tests
- `src/memory/index.ts` - Added dream + rem-exploration exports

## Decisions Made

[Key decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 28 complete, ready for Phase 29: Enhanced Forgetting
</output>
