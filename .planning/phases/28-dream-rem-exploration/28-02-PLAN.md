---
phase: 28-dream-rem-exploration
plan: 02
type: tdd
---

<objective>
Implement the dream orchestrator — coordinates NREM consolidation followed by REM exploration in a single dream cycle, returning combined results.

Purpose: Create dream.ts as the unified entry point for the sleep-tick dream cycle. NREM runs first (consolidating existing clusters), then REM explores novel connections. This follows the biological NREM→REM ordering from PAD research and provides a natural extension point for Phase 30 (Self-Reflection).
Output: Working, tested dream.ts with dream() function and DreamResult type.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-dream-rem-exploration/28-RESEARCH.md
@.planning/phases/28-dream-rem-exploration/28-01-SUMMARY.md

# Key source files:
@src/memory/nrem-consolidation.ts
@src/memory/rem-exploration.ts
@src/memory/db.ts

**Tech stack available:** nremConsolidate, remExplore, NremResult, RemExplorationResult, LLMProvider
**Established patterns:** Pure function orchestration, per-phase error isolation
**Constraining decisions:**
- RESEARCH.md: Sequential NREM→REM (not parallel) — biologically accurate, NREM creates cleaner clusters for REM
- RESEARCH.md: dream.ts is a pure coordinator — no DB access, caller handles storage
- Phase 27: nremConsolidate returns NremResult { clustersProcessed, fusionResults, failures }
- Plan 28-01: remExplore returns RemExplorationResult { seedsExplored, candidatesEvaluated, discoveries, failures }
</context>

<feature>
  <name>Dream Orchestrator</name>
  <files>src/memory/dream.ts, src/memory/dream.test.ts</files>
  <behavior>
    Types:
    - DreamConfig: { nrem?: Partial&lt;NremConfig&gt;, rem?: Partial&lt;RemConfig&gt;, skipNrem?: boolean, skipRem?: boolean }
    - DreamResult: { nrem: NremResult | null, rem: RemExplorationResult | null }

    dream(memories, getRelations, nremProvider, remProvider, config?) → DreamResult:
    - If !skipNrem: run nremConsolidate(memories, getRelations, nremProvider, config.nrem)
    - If !skipRem: run remExplore(memories, getRelations, remProvider, config.rem)
    - NREM runs FIRST, REM runs SECOND (sequential, not parallel)
    - If NREM fails entirely (throws): catch, set nrem=null, still attempt REM
    - If REM fails entirely (throws): catch, set rem=null, still return NREM results
    - Both can be skipped via config flags (for testing or incremental rollout)

    Edge cases:
    - Empty memories → both phases return empty results (not null)
    - skipNrem=true → nrem is null in result, REM still runs
    - skipRem=true → rem is null in result, NREM still runs
    - Both skip=true → { nrem: null, rem: null }
    - NREM provider throws → nrem: null, REM still attempted
    - REM provider throws → rem: null, NREM result preserved
    - Same provider for both → works (providers are stateless)
  </behavior>
  <implementation>
    Create src/memory/dream.ts:
    - Import nremConsolidate, NremResult, NremConfig from nrem-consolidation.js
    - Import remExplore, RemExplorationResult, RemConfig from rem-exploration.js
    - Import types from db.js, providers/types.js
    - Single exported async function dream()
    - Export DreamConfig, DreamResult types
    - No DEFAULT_DREAM_CONFIG needed — just passes through to NREM/REM defaults
    - Minimal orchestrator — delegates all logic to NREM and REM modules
    - Error isolation between phases: try/catch around each
  </implementation>
</feature>

<verification>
npm test -- src/memory/dream.test.ts
All tests pass, covering: sequential execution (NREM before REM), skip flags, phase isolation (NREM failure doesn't block REM), empty input, config passthrough, both providers can be same instance
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- dream.ts passes all tests (GREEN)
- Refactor if needed (REFACTOR)
- dream() runs NREM before REM (sequential order verified)
- Phase isolation works (NREM failure → REM still runs)
- Skip flags work independently
- Config passthrough to NREM/REM modules works
- Pure function — no DB access, no side effects
</success_criteria>

<output>
After completion, create `.planning/phases/28-dream-rem-exploration/28-02-SUMMARY.md`
</output>
