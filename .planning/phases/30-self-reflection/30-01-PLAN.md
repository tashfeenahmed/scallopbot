---
phase: 30-self-reflection
plan: 01
type: tdd
---

<objective>
Build the `reflect()` pure function module that generates composite reflections from session summaries and re-distills SOUL.md behavioral guidelines.

Purpose: Create the core reflection logic as a testable pure function (no I/O), following the same pattern as dream.ts, nrem-consolidation.ts, and rem-exploration.ts. Two LLM calls: (1) composite reflection generating insights, (2) SOUL.md re-distillation merging old guidelines with new learnings.
Output: Working, tested `src/memory/reflection.ts` module with `reflect()` function and all types exported.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-self-reflection/30-RESEARCH.md

# Key source files (patterns to follow):
@src/memory/dream.ts
@src/memory/nrem-consolidation.ts
@src/memory/rem-exploration.ts
@src/memory/session-summary.ts
@src/memory/db.ts

# Prior phase summaries (dependency context):
@.planning/phases/27-dream-nrem-consolidation/27-02-SUMMARY.md
@.planning/phases/28-dream-rem-exploration/28-01-SUMMARY.md

**Tech stack available:** Vitest, LLMProvider interface, SessionSummaryRow type, pure function pattern
**Established patterns:** Pure coordinator functions (dream.ts), JSON-output LLM prompts (session-summary.ts, nrem-consolidation.ts), per-phase error isolation, DEFAULT_CONFIG exports
**Constraining decisions:**
- Phase 28: dream.ts established pure coordinator pattern (sequential phases with per-phase error isolation)
- Phase 27: NREM established buildPrompt + parse pattern for LLM fusion calls
- RESEARCH.md: Use Composite reflection type (Renze & Guven), SOUL re-distillation (MARS + EvolveR hybrid), 400-600 word limit on SOUL output
</context>

<feature>
  <name>Self-Reflection Module (reflect function)</name>
  <files>src/memory/reflection.ts, src/memory/reflection.test.ts</files>
  <behavior>
    **Input:** SessionSummaryRow[], currentSoulContent (string|null), LLMProvider, ReflectionConfig?
    **Output:** ReflectionResult { insights[], updatedSoul, skipped, skipReason? }

    Cases:
    1. No sessions → { skipped: true, skipReason: 'No qualifying sessions', insights: [], updatedSoul: null }
    2. Sessions below minMessages threshold (all sessions have < 3 messages) → { skipped: true, skipReason: 'No sessions with sufficient depth', insights: [], updatedSoul: null }
    3. Valid sessions, null SOUL → LLM call 1 generates insights, LLM call 2 creates initial SOUL from scratch → { skipped: false, insights: [...], updatedSoul: '...' }
    4. Valid sessions, existing SOUL → LLM call 1 generates insights, LLM call 2 re-distills SOUL merging old + new → { skipped: false, insights: [...], updatedSoul: '...' }
    5. LLM returns malformed JSON for reflection → fallback: single raw insight from response text
    6. LLM returns malformed JSON for SOUL → updatedSoul: null (keep existing, don't corrupt)
    7. SOUL output exceeds maxSoulWords → truncate to limit (split at last complete sentence within limit)

    **Config defaults:**
    - minSessions: 1
    - minMessagesPerSession: 3
    - maxSoulWords: 600

    **LLM call 1 (buildReflectionPrompt):**
    - Input: filtered session summaries (topics + summary text + message count)
    - Prompt: Composite reflection type — explain what went well/poorly, extract principles (do's/don'ts), identify patterns
    - Expected JSON output: { "insights": [{ "content": "...", "topics": ["..."] }], "principles": ["..."] }

    **LLM call 2 (buildSoulDistillationPrompt):**
    - Input: current SOUL content (or null) + insights + principles from call 1
    - Prompt: Re-distill into updated behavioral guidelines document, 400-600 words, written as instructions to the assistant
    - Expected output: raw markdown string (not JSON)
  </behavior>
  <implementation>
    Create `src/memory/reflection.ts` with:

    1. **Types:** ReflectionConfig, ReflectionResult, ReflectionInsight (content, topics, sourceSessionIds)
    2. **Config:** DEFAULT_REFLECTION_CONFIG with defaults
    3. **buildReflectionPrompt(summaries):** Constructs composite reflection prompt from session summaries. Include session topics, summary text, and message counts. Request JSON output with insights array and principles array. Follow Renze & Guven Composite type: explanation + advice + instructions + principles.
    4. **buildSoulDistillationPrompt(currentSoul, insights, principles):** Constructs SOUL re-distillation prompt. If currentSoul is null, instruct to create initial guidelines. If exists, instruct to merge old + new. Enforce 400-600 word target. Output is raw markdown.
    5. **reflect(summaries, currentSoul, provider, config?):** Main function:
       a. Filter summaries to those with >= minMessagesPerSession messages
       b. If filtered count < minSessions, return skipped
       c. Call provider.complete with reflection prompt, parse JSON response
       d. If JSON parse fails, create single fallback insight from raw text
       e. Call provider.complete with SOUL distillation prompt, get raw text
       f. If SOUL response empty/malformed, set updatedSoul to null
       g. If SOUL word count > maxSoulWords, truncate at last sentence boundary
       h. Attach sourceSessionIds to each insight (all qualifying session IDs — insights are session-level, not per-session)
       i. Return ReflectionResult

    Export: reflect, buildReflectionPrompt, buildSoulDistillationPrompt, DEFAULT_REFLECTION_CONFIG, types
  </implementation>
</feature>

<verification>
npm test -- src/memory/reflection.test.ts
All tests pass (expect 7+ tests covering all behavior cases)
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed
- All 2-3 commits present
- reflect() handles all 7 behavior cases from feature spec
- Prompt construction follows Composite reflection pattern from RESEARCH.md
- SOUL distillation follows re-distillation pattern from RESEARCH.md
- Pure function — no file I/O, no database access
- Types and config exported for use by wiring plan
</success_criteria>

<output>
After completion, create `.planning/phases/30-self-reflection/30-01-SUMMARY.md`
</output>
