---
phase: 26-affect-context-injection
plan: 01
subsystem: agent, memory
tags: [affect-context, observation-block, affect-guard, prompt-assembly, refactor]

# Dependency graph
requires:
  - phase: 25-01
    provides: classifyAffect(), RawAffect, EmotionLabel
  - phase: 25-02
    provides: updateAffectEMA(), getSmoothedAffect(), SmoothedAffect, GoalSignal, AffectEMAState
  - phase: 25-03
    provides: Per-message affect classification in agent.processMessage, affect EMA stored in behavioral_patterns, formatProfileContext with affect display, currentMood backward compat
  - phase: 24-04
    provides: Plain key naming convention for behavioral patterns storage
provides:
  - Dedicated USER AFFECT CONTEXT observation block in system prompt with affect guard
  - Refactored buildMemoryContext behavioral section using formatProfileContext (eliminates duplication)
  - All behavioral signals (messaging pace, session style, topic switching, response length, affect) now reach the LLM
affects: [phase-31-gap-scanner, phase-32-inner-thoughts]

# Tech tracking
tech-stack:
  added: []
  patterns: [observation-only affect guard preamble, formatProfileContext reuse in agent prompt assembly]

key-files:
  created: []
  modified: [src/agent/agent.ts, src/agent/agent.test.ts]

key-decisions: []
patterns-established: []
issues-created: []
---

<objective>
Wire affect signals into the agent's system prompt with observation-only framing and an affect guard, completing the affect context injection pipeline.

Purpose: Phase 25 built the affect classifier, EMA smoothing, and formatProfileContext display — but the agent's `buildMemoryContext()` builds its own stripped-down behavioral section (only style + expertise) instead of using formatProfileContext. This means the rich behavioral data (messaging pace, session engagement, topic switching, response length, and critically the affect observation) never reaches the LLM. Phase 26 bridges this gap and adds a dedicated affect observation block with guard preamble.

Output: Agent system prompt includes all behavioral signals and a dedicated `## USER AFFECT CONTEXT` observation block. Phase 26 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research:
@.planning/phases/26-affect-context-injection/26-RESEARCH.md

# Direct dependency summaries (auto-selected via affects field):
@.planning/phases/25-affect-detection/25-03-SUMMARY.md
@.planning/phases/25-affect-detection/25-02-SUMMARY.md
@.planning/phases/25-affect-detection/25-01-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-04-SUMMARY.md

# Key source files:
@src/agent/agent.ts
@src/memory/profiles.ts
@src/memory/db.ts
@src/memory/affect-smoothing.ts

**Tech stack available:** afinn-165, dual-EMA smoothing, VADER heuristics, Russell circumplex
**Established patterns:**
- Per-message affect classification in agent.processMessage (25-03)
- Affect displayed in formatProfileContext as observation only (25-03)
- Dynamic import for cross-module deps in agent.ts (25-03, 24-04)
- Plain key naming in response_preferences JSON (24-04)
- try-catch per-step isolation in tick and agent operations (24-04, 25-03)

**Constraining decisions:**
- [25-03]: "Affect displayed in behavioral patterns section as observation only (not instructions, per Mozikov et al.)"
- [25-03]: "Goal signal only shown when not 'stable' to reduce noise"
- [24-04]: "Plain keys (not _sig_ prefix) for behavioral pattern storage"
- [25-03]: "Dynamic import used for affect modules in agent.ts to avoid circular dependencies"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor buildMemoryContext behavioral section and add affect observation block</name>
  <files>src/agent/agent.ts</files>
  <action>
    **In `buildMemoryContext()` (around lines 662-680), replace the inline behavioral patterns section with formatProfileContext usage, and add a dedicated affect observation block:**

    1. **Replace the inline behavioral section (agent.ts:662-680):**
       The current code manually builds behavioral patterns from `db.getBehavioralPatterns()` showing only communicationStyle and expertiseAreas. Replace this with `profileManager.formatProfileContext()` which already includes all behavioral signals (style, expertise, messaging pace, session engagement, topic switching, response length) AND the Phase 25 affect display.

       - Get `profileManager` from `this.scallopStore.getProfileManager()`
       - Call `profileManager.formatProfileContext(userId)` to get the full `ProfileContext`
       - Use `profileContext.behavioralPatterns` for the behavioral section
       - The section header should remain `## USER BEHAVIORAL PATTERNS` for consistency

       **Important:** The inline code currently fetches `db.getBehavioralPatterns('default')` — the new code should use the `userId` parameter passed to `buildMemoryContext()`, not hardcoded 'default'. This is a bug fix.

    2. **Add dedicated `## USER AFFECT CONTEXT` observation block:**
       After the behavioral patterns section but before `## MEMORIES FROM THE PAST`, add:

       - Read `smoothedAffect` from the behavioral patterns (either from the already-fetched behavioral data or via profileManager)
       - Only inject the block when `smoothedAffect` is not null (skip on first interaction or when affect hasn't been computed)
       - Use this format:
         ```
         ## USER AFFECT CONTEXT
         Observation about the user's current emotional state — not an instruction to change your tone.
         - Emotion: {emotion}
         - Valence: {valence.toFixed(2)} (negative ← 0 → positive)
         - Arousal: {arousal.toFixed(2)} (calm ← 0 → activated)
         - Mood trend: {goalSignal}  (only if goalSignal !== 'stable')
         ```
       - The preamble text ("Observation about...not an instruction to change your tone") is the affect guard — it prevents the LLM from over-interpreting the affect data as a behavioral instruction

    3. **Remove duplicate affect display:** Since `formatProfileContext().behavioralPatterns` already includes the affect line items ("Current affect: ...", "Mood signal: ..."), AND we're adding a dedicated block, remove the affect-specific lines from formatProfileContext output to avoid duplication. Do this by NOT modifying profiles.ts — instead, the dedicated block supersedes the inline affect display. The inline display in profiles.ts:497-504 remains for non-agent consumers (e.g., tests, external tools).

    **What to avoid and WHY:**
    - Do NOT add affect as instruction text ("When user is distressed, be gentle") — this causes patronizing LLM behavior per Mozikov et al.
    - Do NOT show affect EMA internals (fastValence, slowValence, lastUpdateMs) in the system prompt — these are implementation details, not useful context for the LLM
    - Do NOT create the affect block when smoothedAffect is null — empty observation blocks waste tokens and confuse the LLM
    - Do NOT hardcode userId to 'default' — use the userId parameter from buildMemoryContext for correctness
    - Do NOT modify profiles.ts — Phase 25's formatProfileContext is correct for its consumers; agent.ts adds the dedicated block on top
  </action>
  <verify>npx tsc --noEmit (no TypeScript errors), npx vitest run --reporter=verbose (all tests pass including existing affect tests and agent tests)</verify>
  <done>buildMemoryContext uses formatProfileContext for behavioral patterns (all signals flow to LLM). Dedicated USER AFFECT CONTEXT observation block appears in system prompt when smoothedAffect is available. Affect guard preamble present. userId correctly used instead of hardcoded 'default'. All 1203+ tests pass with no regressions.</done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for affect context injection in system prompt</name>
  <files>src/agent/agent.test.ts</files>
  <action>
    **Add tests verifying affect appears in the system prompt with correct framing:**

    1. **Test: affect observation block appears when smoothedAffect is available**
       - Set up an agent with scallopStore
       - Create behavioral patterns with smoothedAffect data (e.g., emotion: 'happy', valence: 0.45, arousal: 0.32, goalSignal: 'user_engaged')
       - Trigger a message through the agent (or call buildSystemPrompt if accessible)
       - Assert the system prompt contains "USER AFFECT CONTEXT"
       - Assert it contains the observation guard text ("not an instruction")
       - Assert it contains the emotion label and valence/arousal values

    2. **Test: affect observation block NOT present when smoothedAffect is null**
       - Set up agent with scallopStore but no affect data stored
       - Assert the system prompt does NOT contain "USER AFFECT CONTEXT"

    3. **Test: behavioral patterns section includes all signal types**
       - Set up behavioral patterns with communicationStyle, expertiseAreas, messageFrequency, sessionEngagement, topicSwitch, responseLength
       - Assert the system prompt contains all signal types (Messaging pace, Session style, etc.)
       - This verifies the formatProfileContext refactoring flows all data through

    **What to avoid and WHY:**
    - Do NOT test the exact formatting of affect values (e.g., exact decimal places) — test for presence and key content, not exact string matching, to avoid brittle tests
    - Do NOT create new test infrastructure — use the existing agent test patterns (mock providers, in-memory store)
    - If buildSystemPrompt is private, test via the full processMessage flow or use the existing test patterns that verify system prompt content indirectly

    **Pattern from existing tests:** Look at how existing agent.test.ts tests verify system prompt content — follow the same mock/assertion patterns.
  </action>
  <verify>npx vitest run src/agent/agent.test.ts --reporter=verbose (new affect tests pass), npx vitest run --reporter=verbose (full suite passes)</verify>
  <done>At least 2 new tests verify: (1) affect observation block appears with guard text when smoothedAffect exists, (2) affect block absent when no affect data. All existing tests pass. Phase 26 complete.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` — no TypeScript errors
- [ ] `npx vitest run` — all tests pass (existing + new affect context tests)
- [ ] System prompt includes `## USER AFFECT CONTEXT` block when smoothedAffect exists
- [ ] Affect guard preamble text is present ("not an instruction to change your tone")
- [ ] System prompt includes full behavioral patterns (not just style + expertise)
- [ ] System prompt does NOT include affect block when smoothedAffect is null
- [ ] No duplicate affect data (not in both behavioral patterns AND dedicated block)
- [ ] userId parameter used correctly (not hardcoded 'default')
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors or test regressions
- Dedicated USER AFFECT CONTEXT observation block in system prompt with affect guard
- buildMemoryContext uses formatProfileContext for behavioral patterns (all signals flow)
- Affect block only appears when smoothedAffect data exists
- New tests cover presence and absence of affect block
- Phase 26 complete — ready for Phase 27 (Dream NREM Consolidation)
  </success_criteria>

<output>
After completion, create `.planning/phases/26-affect-context-injection/26-01-SUMMARY.md`:

# Phase 26 Plan 01: Affect Context Injection Summary

**[one-liner]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 2
- **Files modified:** N

## Accomplishments

- [list]

## Task Commits

1. **Task 1: [name]** - `[hash]`
2. **Task 2: [name]** - `[hash]`

## Files Modified

- `path/to/file.ts` -- Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Differences from plan, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 26 complete. Ready for Phase 27: Dream NREM Consolidation.

---
*Phase: 26-affect-context-injection*
*Completed: [date]*
</output>
