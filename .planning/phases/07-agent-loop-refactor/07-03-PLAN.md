---
phase: 07-agent-loop-refactor
plan: 03
type: execute
---

<objective>
Make toolRegistry optional and update Gateway to create SkillExecutor for skill-based execution.

Purpose: After 07-02, skills handle execution but toolRegistry is still required. This plan makes toolRegistry fully optional and updates Gateway to initialize SkillExecutor, completing the skills-only architecture.
Output: Agent works without toolRegistry, Gateway creates SkillExecutor, tool layer is optional.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase
@.planning/phases/07-agent-loop-refactor/07-01-PLAN.md
@.planning/phases/07-agent-loop-refactor/07-02-PLAN.md

# Source files
@src/agent/agent.ts
@src/gateway/gateway.ts
@src/skills/executor.ts

**Tech stack available:** SkillRegistry, SkillExecutor, Agent with skill execution
**Established patterns:**
- Agent has fallback to toolRegistry in executeTools()
- Gateway creates Agent with toolRegistry
**Constraining decisions:**
- Keep tool layer importable but not required
- Don't delete tool files yet (deprecation, not removal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make toolRegistry optional in Agent</name>
  <files>src/agent/agent.ts</files>
  <action>
Update AgentOptions and Agent constructor to make toolRegistry optional.

1. In AgentOptions interface:
   ```typescript
   interface AgentOptions {
     // ... existing required fields
     toolRegistry?: ToolRegistry;  // Change from required to optional
     skillRegistry?: SkillRegistry;
     skillExecutor?: SkillExecutor;
     // ... rest
   }
   ```

2. In constructor:
   ```typescript
   this.toolRegistry = options.toolRegistry || null;
   ```

3. In executeTools(), update the fallback to check if toolRegistry exists:
   ```typescript
   // Fallback to tool (backward compatibility)
   if (this.toolRegistry) {
     const tool = this.toolRegistry.getTool(toolUse.name);
     if (tool) {
       // ... existing tool execution logic
       continue;
     }
   }

   // Neither skill nor tool found
   this.logger.warn({ name: toolUse.name }, 'Unknown skill/tool requested');
   ```

4. Remove any code that assumes toolRegistry is always present.

The agent should work with ONLY skillRegistry + skillExecutor (no toolRegistry).
  </action>
  <verify>npm run build succeeds, Agent can be created without toolRegistry</verify>
  <done>toolRegistry is optional in Agent, agent works with skills-only</done>
</task>

<task type="auto">
  <name>Task 2: Update Gateway to create SkillExecutor</name>
  <files>src/gateway/gateway.ts</files>
  <action>
Update Gateway.initialize() to:
1. Create SkillExecutor instance
2. Pass skillExecutor to Agent
3. Make toolRegistry creation optional (controlled by config flag or presence of tools)

Changes:

1. Add import:
   ```typescript
   import { createSkillExecutor, SkillExecutor } from '../skills/executor.js';
   ```

2. Add private field:
   ```typescript
   private skillExecutor: SkillExecutor | null = null;
   ```

3. In initialize(), after skillRegistry initialization:
   ```typescript
   // Create skill executor for skill-based execution
   this.skillExecutor = createSkillExecutor(this.logger);
   ```

4. Update Agent creation:
   ```typescript
   this.agent = new Agent({
     provider,
     sessionManager: this.sessionManager,
     toolRegistry: this.toolRegistry,  // Keep for backward compatibility
     skillRegistry: this.skillRegistry,
     skillExecutor: this.skillExecutor,  // ADD THIS
     // ... rest of options
   });
   ```

5. Optionally, add a config flag to skip tool registry creation:
   ```typescript
   // In initialize()
   if (config.enableTools !== false) {
     this.toolRegistry = await createDefaultToolRegistry({ ... });
   }
   ```

This allows the gateway to run in skills-only mode when tools are disabled.
  </action>
  <verify>npm run build succeeds, Gateway creates SkillExecutor and passes to Agent</verify>
  <done>Gateway creates SkillExecutor, Agent receives skillExecutor, toolRegistry is optional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Agent can be instantiated without toolRegistry (TypeScript allows it)
- [ ] Gateway creates SkillExecutor and passes to Agent
- [ ] Agent skill execution works end-to-end (skills respond to LLM tool calls)
- [ ] Existing tool functionality still works (backward compatibility)
</verification>

<success_criteria>

- toolRegistry optional in Agent
- Gateway creates SkillExecutor
- Phase 7 complete - skills-only execution loop working
- All verification checks pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-agent-loop-refactor/07-03-SUMMARY.md` with:

## Phase 7 Complete

Phase 7: Agent Loop Refactor is complete. The agent now:
- Uses skill descriptions in system prompt (07-01)
- Generates tool definitions from skills (07-02)
- Executes skills via SkillExecutor (07-02)
- Works without toolRegistry (07-03)

Ready for Phase 8: Kimi K2.5 Thinking Mode
</output>
