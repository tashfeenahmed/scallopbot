---
phase: 25-affect-detection
plan: 01
type: tdd
---

<objective>
Build the core affect classifier: a pure function that takes user message text and returns `{valence, arousal, emotion, confidence}` using AFINN-165 for valence, a curated arousal word list, VADER-style negation/booster heuristics, and Russell circumplex emotion mapping.

Purpose: This is the foundational computation layer for all affect-aware features (Phase 26 context injection, Phase 31 gap scanner affect context, Phase 32 suppression when stressed). Must be deterministic, fast, and testable.
Output: `affect.ts` (classifier + types), `affect-lexicon.ts` (arousal map + boosters + negation set + emoji map), passing test suite.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-affect-detection/25-RESEARCH.md

# Prior phase summaries (dependency graph):
@.planning/phases/22-behavioral-profiling/22-01-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-04-SUMMARY.md

# Key source files:
@src/memory/behavioral-signals.ts
@src/memory/index.ts

**Tech stack available:** AFINN-165 npm (MIT, ESM), vitest, TypeScript
**Established patterns:** Pure stateless functions (trust-score.ts, health-ping.ts, behavioral-signals.ts), TDD with vitest
**Constraining decisions:**
- Phase 22: Stateless pure functions for signal computation
- Phase 24: Plain keys (not _sig_ prefix) for v4.0 behavioral patterns
- v3.0: Opt-in provider pattern, fast-tier provider reuse

**From RESEARCH.md — Don't hand-roll:**
- Valence word list → use AFINN-165 (`npm install afinn-165`)
- EMA smoothing → use existing `updateEMA()` (Plan 02 concern)
- Dynamic profile updates → use existing `setCurrentMood()` (Plan 03 concern)

**From RESEARCH.md — Pitfalls to address in tests:**
- Negation: "not happy" must score negative
- Short messages: confidence=0 when no sentiment words found
- Arousal ≠ intensity: "depressed" is low arousal despite high valence magnitude
- Bot contamination: only classify user messages (caller responsibility, but document)
</context>

<feature>
  <name>Affect Classifier (classifyAffect)</name>
  <files>src/memory/affect.ts, src/memory/affect-lexicon.ts, src/memory/affect.test.ts</files>
  <behavior>
    classifyAffect(text: string) → RawAffect { valence, arousal, emotion, confidence }

    Core behavior cases:
    - "I'm so happy today!" → valence > 0, emotion = 'happy' or 'excited'
    - "This is terrible and frustrating" → valence < 0, arousal > 0, emotion = 'frustrated' or 'angry'
    - "I feel sad and tired" → valence < 0, arousal < 0, emotion = 'sad'
    - "Everything is calm and peaceful" → valence > 0, arousal < 0, emotion = 'calm' or 'content'
    - "" (empty) → valence = 0, arousal = 0, emotion = 'neutral', confidence = 0
    - "the meeting is at 3pm" → emotion = 'neutral', confidence ≈ 0 (no sentiment words)

    Negation handling:
    - "I'm not happy" → valence < 0 (negation flips "happy")
    - "never been better" → valence > 0 (negation flips "better", but "never" + negative = positive)
    - "not bad at all" → valence > 0 (negation flips "bad" to positive)

    Booster/intensifier handling:
    - "very happy" → higher valence than "happy" alone
    - "extremely angry" → more negative valence than "angry" alone
    - "slightly annoyed" → less negative than "annoyed" alone

    Emotion mapping (Russell circumplex):
    - Q1 (v>0, a>0): 'excited' (high arousal) or 'happy' (moderate)
    - Q2 (v>0, a≤0): 'content' (high valence) or 'calm' (moderate)
    - Q3 (v≤0, a≤0): 'sad'
    - Q4 (v≤0, a>0): 'angry' (extreme), 'anxious' (moderate), 'frustrated' (mild)
    - Center: 'neutral' (|v|<0.1 && |a|<0.15)

    Confidence:
    - Based on ratio of matched sentiment words to total tokens
    - 0 words matched → confidence = 0
    - All words matched → confidence = 1.0

    mapToEmotion(valence, arousal) → EmotionLabel (exported, testable separately)

    Lexicon module (affect-lexicon.ts):
    - AROUSAL_MAP: ~150-200 curated words with arousal scores (-1 to +1)
    - NEGATION_WORDS: Set of ~30 negation tokens (VADER-derived)
    - BOOSTER_DICT: ~40 intensifier words with scalar values (VADER-derived)
    - EMOJI_VALENCE: ~30 common emoji with valence+arousal scores
    - N_SCALAR: -0.74 (VADER negation dampening factor)
  </behavior>
  <implementation>
    1. Install afinn-165: `npm install afinn-165`
    2. Create `affect-lexicon.ts`:
       - Import afinn165 from 'afinn-165'
       - Export AROUSAL_MAP: Record<string, number> with ~150-200 curated arousal words
         High arousal (+0.5 to +1.0): excited, furious, terrified, ecstatic, panicked, thrilled, enraged, frantic, hysterical, manic, elated, livid, raging, screaming, explosive
         Moderate arousal (+0.1 to +0.5): happy, angry, anxious, surprised, worried, eager, annoyed, alarmed, tense, nervous, irritated, enthusiastic, agitated, impatient, determined
         Low arousal (-0.5 to -0.1): calm, relaxed, tired, bored, lazy, sleepy, mellow, passive, sluggish, lethargic, drowsy, weary, listless, indifferent, resigned
         Very low arousal (-1.0 to -0.5): peaceful, serene, tranquil, still, quiet, numb, dull, lifeless, exhausted, comatose, unconscious, inert, dormant
       - Export NEGATION_WORDS: Set<string> (~30 words from VADER)
       - Export BOOSTER_DICT: Record<string, number> (~40 intensifiers from VADER)
       - Export EMOJI_VALENCE: Map<string, {v: number, a: number}> (~30 common emoji)
       - Export N_SCALAR = -0.74
    3. Create `affect.ts`:
       - Import afinn165 from 'afinn-165', import lexicon exports
       - tokenize(text): lowercase, split on whitespace/punctuation, filter empty. Handle contractions (don't → dont for negation matching).
       - scoreTokens(tokens): iterate tokens, for each:
         a. Check if token is emoji → use EMOJI_VALENCE
         b. Check if token is in afinn165 → get valence score (-5 to +5), normalize to -1..+1 by dividing by 5
         c. Check preceding token for booster → adjust score
         d. Check 3 preceding tokens for negation → apply N_SCALAR
         e. Check if token is in AROUSAL_MAP → accumulate arousal
         f. Track matchCount for confidence
         Return { valence: avg of scores, arousal: avg of arousal matches, matchCount }
       - mapToEmotion(v, a): circumplex quadrant mapping per RESEARCH.md
       - classifyAffect(text): tokenize → scoreTokens → mapToEmotion → return RawAffect
       - Export: RawAffect, EmotionLabel, classifyAffect, mapToEmotion
    4. Types: RawAffect { valence: number, arousal: number, emotion: EmotionLabel, confidence: number }
       EmotionLabel = 'happy' | 'excited' | 'calm' | 'content' | 'sad' | 'angry' | 'anxious' | 'frustrated' | 'neutral'
  </implementation>
</feature>

<verification>
npx vitest run src/memory/affect.test.ts --reporter=verbose
All tests pass, covering:
- Basic positive/negative/neutral classification
- Negation handling (3+ cases)
- Booster/intensifier handling (3+ cases)
- Emotion quadrant mapping (all 4 quadrants + neutral center)
- Empty/no-sentiment-word messages → confidence = 0
- Emoji handling (basic positive/negative)
</verification>

<success_criteria>

- Failing tests written and committed (RED)
- classifyAffect implementation passes all tests (GREEN)
- Refactor complete if needed (REFACTOR)
- All 2-3 commits present
- afinn-165 installed as dependency
- affect-lexicon.ts contains curated arousal map (~150+ words), negation set, booster dict, emoji map
- affect.ts exports classifyAffect and mapToEmotion as pure functions
- Negation correctly flips sentiment for "not happy", "never been better"
- Arousal dimension is independent from valence magnitude (not derived from |valence|)
- No database access, no side effects, no async in classifier
  </success_criteria>

<output>
After completion, create `.planning/phases/25-affect-detection/25-01-SUMMARY.md`
</output>
