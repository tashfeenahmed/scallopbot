---
phase: 25-affect-detection
plan: 02
type: tdd
---

<objective>
Build the affect EMA smoothing layer: dual-EMA (fast + slow) for valence and arousal, plus goal signal derivation from EMA divergence. Reuses existing `updateEMA()` from behavioral-signals.ts.

Purpose: Raw per-message affect is noisy — EMA smoothing produces stable mood signals. The dual-EMA pattern (fast reacts, slow tracks baseline) enables goal signal detection ("user getting distressed" vs "user improving") that Phase 26 context injection and Phase 31 gap scanner consume.
Output: `affect-smoothing.ts` (EMA update + goal signal functions + types), passing test suite.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-affect-detection/25-RESEARCH.md
@.planning/phases/25-affect-detection/25-01-SUMMARY.md

# Key source files:
@src/memory/behavioral-signals.ts
@src/memory/affect.ts
@src/memory/affect-lexicon.ts

**Tech stack available:** updateEMA() from behavioral-signals.ts, vitest
**Established patterns:** EMA with irregular time intervals and half-life decay (behavioral-signals.ts)
**Constraining decisions:**
- Phase 22: updateEMA uses weight = 1 - exp(-timeDelta / halfLife), DEFAULT_HALF_LIFE_MS = 7 days
- RESEARCH.md: Fast EMA half-life = 2 hours, Slow EMA half-life = 3 days
- RESEARCH.md: Skip EMA update when confidence < 0.1 (no sentiment words found)

**From RESEARCH.md — Don't hand-roll:**
- EMA smoothing → reuse existing `updateEMA()` from behavioral-signals.ts
- Trend detection → reuse existing `detectTrend()` if needed

**From RESEARCH.md — Pitfalls:**
- Over-responsive EMA: single angry message shouldn't permanently shift mood
- Neutral collapse: low-confidence readings (no sentiment words) must NOT update EMA
</context>

<feature>
  <name>Affect EMA Smoothing and Goal Signal</name>
  <files>src/memory/affect-smoothing.ts, src/memory/affect-smoothing.test.ts</files>
  <behavior>
    AffectEMAState { fastValence, slowValence, fastArousal, slowArousal, lastUpdateMs }

    updateAffectEMA(state, rawAffect, nowMs) → AffectEMAState:
    - Uses updateEMA() from behavioral-signals.ts for each of 4 channels
    - Fast half-life: 2 hours (7_200_000 ms) — reacts to mood shifts within session
    - Slow half-life: 3 days (259_200_000 ms) — tracks baseline mood
    - If rawAffect.confidence < 0.1 → return state unchanged (no update)
    - If state.lastUpdateMs === 0 (initial) → set all channels to raw values directly
    - Returns new state with updated EMA values and lastUpdateMs = nowMs

    deriveGoalSignal(state) → GoalSignal:
    - Compares fast vs slow valence to detect mood transitions
    - fastValence - slowValence < -0.15 → 'user_distressed'
    - fastValence - slowValence > 0.15 → 'user_improving'
    - fastArousal > 0.4 → 'user_engaged'
    - fastArousal < -0.3 && fastValence < -0.1 → 'user_disengaged'
    - Otherwise → 'stable'

    getSmoothedAffect(state) → SmoothedAffect:
    - Derives emotion label from fast EMA values using mapToEmotion (from affect.ts)
    - Derives goalSignal from state
    - Returns { valence: fastValence, arousal: fastArousal, emotion, goalSignal }

    createInitialAffectState() → AffectEMAState:
    - All values 0, lastUpdateMs = 0

    Test cases:
    - Initial state + positive message → positive EMA values
    - Multiple positive messages → EMA converges toward positive
    - Single negative after many positive → fast shifts, slow barely moves
    - Low confidence message (no sentiment words) → state unchanged
    - Goal signal: fast < slow by 0.2 → 'user_distressed'
    - Goal signal: fast > slow by 0.2 → 'user_improving'
    - Goal signal: high arousal → 'user_engaged'
    - Goal signal: low arousal + negative → 'user_disengaged'
    - Goal signal: similar fast/slow → 'stable'
    - Time gap: large timeDelta causes faster convergence (EMA half-life behavior)
  </behavior>
  <implementation>
    1. Create `affect-smoothing.ts`:
       - Import updateEMA from './behavioral-signals.js'
       - Import mapToEmotion, type RawAffect, type EmotionLabel from './affect.js'
       - Define constants: FAST_HALF_LIFE_MS = 2 * 60 * 60 * 1000 (2h), SLOW_HALF_LIFE_MS = 3 * 24 * 60 * 60 * 1000 (3d), MIN_CONFIDENCE = 0.1
       - Define AffectEMAState interface
       - Define GoalSignal type = 'user_distressed' | 'user_improving' | 'user_engaged' | 'user_disengaged' | 'stable'
       - Define SmoothedAffect interface { valence, arousal, emotion: EmotionLabel, goalSignal: GoalSignal }
       - Implement createInitialAffectState(): returns zero state
       - Implement updateAffectEMA(state, raw, nowMs): confidence gate, initial state shortcut, 4-channel EMA update
       - Implement deriveGoalSignal(state): threshold comparisons
       - Implement getSmoothedAffect(state): combines mapToEmotion + deriveGoalSignal
       - All functions are pure, stateless, synchronous
    2. Export types and functions
  </implementation>
</feature>

<verification>
npx vitest run src/memory/affect-smoothing.test.ts --reporter=verbose
All tests pass, covering:
- Initial state creation
- EMA update with positive/negative affect
- Confidence gating (low confidence → no update)
- Goal signal derivation for all 5 states
- Dual-EMA divergence detection
- Time sensitivity (EMA converges faster with larger timeDelta)
</verification>

<success_criteria>

- Failing tests written and committed (RED)
- affect-smoothing.ts implementation passes all tests (GREEN)
- Refactor complete if needed (REFACTOR)
- All 2-3 commits present
- updateEMA from behavioral-signals.ts reused (NOT hand-rolled)
- Confidence gating prevents neutral collapse
- Fast EMA responds faster than slow EMA to mood changes
- Goal signal correctly derives from fast/slow divergence
- All functions are pure, no database access, no side effects
  </success_criteria>

<output>
After completion, create `.planning/phases/25-affect-detection/25-02-SUMMARY.md`
</output>
