---
phase: 24-heartbeat-tier-enhancements
plan: 05
type: execute
---

<objective>
Add Tier 3 (Sleep) scheduling infrastructure to BackgroundGardener.

Purpose: Create the nightly sleep tick mechanism that Phase 27-30 (NREM dreams, REM exploration, self-reflection) will hook into. This is a scheduling-only infrastructure change — no sleep operations yet, just the timer and quiet hours gating.
Output: BackgroundGardener with sleepTick() method, tick counter, quiet hours detection, and configurable quiet hours in options. Phase 24 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-heartbeat-tier-enhancements/24-RESEARCH.md
@.planning/phases/24-heartbeat-tier-enhancements/24-04-SUMMARY.md

@src/memory/memory.ts

**Tech stack available:** All existing
**Established patterns:** Tick-counter approach (DEEP_EVERY = 72), setInterval timer lifecycle
**Constraining decisions:**
- Research: Tick-counter with wall-clock gate (consistent with existing DEEP_EVERY pattern)
- Research: SLEEP_EVERY = 288 ticks (24 hours at 5-min intervals)
- Research: Quiet hours configurable (default 2-5 AM), global config in BackgroundGardenerOptions
- Research: If threshold reached outside quiet hours, defer to next quiet window
- Research: sleepTick() is async placeholder — Phase 27+ will fill in operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tier 3 sleep tick infrastructure</name>
  <files>src/memory/memory.ts</files>
  <action>
  1. Add to BackgroundGardenerOptions:
     ```typescript
     /** Quiet hours for sleep tick (default: 2-5 AM local time) */
     quietHours?: { start: number; end: number }; // 24h format, e.g. { start: 2, end: 5 }
     ```

  2. Add to BackgroundGardener class:
     ```typescript
     private static readonly SLEEP_EVERY = 288; // 24 hours at 5-min intervals
     private sleepTickCount = 0;
     private quietHours: { start: number; end: number };
     ```
     Initialize quietHours from options (default { start: 2, end: 5 }) in constructor.

  3. Add isQuietHours() private method:
     ```typescript
     private isQuietHours(): boolean {
       const hour = new Date().getHours();
       if (this.quietHours.start < this.quietHours.end) {
         return hour >= this.quietHours.start && hour < this.quietHours.end;
       }
       // Handle wrap-around (e.g., start: 23, end: 5)
       return hour >= this.quietHours.start || hour < this.quietHours.end;
     }
     ```

  4. Add sleepTick() async method:
     ```typescript
     async sleepTick(): Promise<void> {
       this.logger.info('Sleep tick: nightly cognitive processing starting');
       // Placeholder for Phase 27+ operations:
       // - NREM consolidation (Phase 27)
       // - REM exploration (Phase 28)
       // - Self-reflection (Phase 30)
       this.logger.info('Sleep tick complete (no operations configured yet)');
     }
     ```

  5. In lightTick(), after the deepTick check block, add sleep tick check:
     ```typescript
     this.sleepTickCount++;
     if (this.sleepTickCount >= BackgroundGardener.SLEEP_EVERY && this.isQuietHours()) {
       this.sleepTickCount = 0;
       this.sleepTick().catch(err => {
         this.logger.warn({ error: (err as Error).message }, 'Sleep tick failed');
       });
     }
     ```

  6. Update the class docstring to mention Tier 3.

  Avoid:
  - Do NOT use a separate timer for sleep tick (keep single timer approach per research recommendation)
  - Do NOT add any sleep operations yet (pure infrastructure)
  - Do NOT use node-cron (tick-counter approach is simpler and consistent)
  </action>
  <verify>
  - `npx tsc --noEmit` — no TypeScript errors
  - `npx vitest run src/memory/` — all tests pass
  </verify>
  <done>
  - SLEEP_EVERY constant defined (288 ticks = 24 hours)
  - sleepTickCount tracked alongside tickCount
  - isQuietHours() correctly handles normal and wrap-around ranges
  - sleepTick() exists as async placeholder
  - lightTick() checks sleep threshold with quiet hours gate
  - quietHours configurable via BackgroundGardenerOptions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for Tier 3 scheduling infrastructure</name>
  <files>src/memory/gardener-tier3.test.ts</files>
  <action>
  Create a focused test file for sleep tick infrastructure:

  1. Test isQuietHours logic (mock Date to control hour):
     - Hour 3, quietHours {2,5} → true
     - Hour 10, quietHours {2,5} → false
     - Hour 23, quietHours {23,5} (wrap-around) → true
     - Hour 3, quietHours {23,5} (wrap-around) → true
     - Hour 12, quietHours {23,5} (wrap-around) → false

  2. Test sleep tick counter:
     - After 287 light ticks → sleepTick NOT called
     - After 288 light ticks during quiet hours → sleepTick IS called and counter resets
     - After 288 light ticks outside quiet hours → sleepTick NOT called, counter NOT reset (deferred)

  3. Test sleep tick deferral:
     - Reach SLEEP_EVERY outside quiet hours → counter stays at 288
     - Next tick enters quiet hours → sleepTick fires, counter resets

  Use vi.useFakeTimers() and vi.spyOn(Date.prototype, 'getHours') to control time.
  Create minimal BackgroundGardener instance with mock ScallopMemoryStore.

  Avoid: Don't test deepTick or lightTick behavior unrelated to Tier 3. Focus only on sleep scheduling.
  </action>
  <verify>
  - `npx vitest run src/memory/gardener-tier3.test.ts` — all tests pass
  - `npx vitest run` — full suite passes, no regressions
  </verify>
  <done>
  - Quiet hours detection tests cover normal range, wrap-around, and boundary conditions
  - Sleep tick counter tests confirm threshold behavior
  - Deferral test confirms quiet hours gate works
  - All tests pass
  - Phase 24 complete
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] `npx vitest run` — full test suite passes (all 1080+ existing + new tests)
- [ ] BackgroundGardener has 3 tiers: lightTick (5 min), deepTick (6 hours), sleepTick (24 hours + quiet hours)
- [ ] No existing behavior changed
- [ ] All Phase 24 features operational: health ping, retrieval audit, trust scoring, goal deadline checks, Tier 3 infrastructure
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Phase 24 complete — all 5 plans executed
- Tier 3 sleep infrastructure ready for Phase 27+
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/24-heartbeat-tier-enhancements/24-05-SUMMARY.md`:

# Phase 24 Plan 05: Tier 3 Sleep Infrastructure Summary

**[One-liner]**

## Accomplishments
## Files Created/Modified
## Decisions Made
## Issues Encountered
## Next Step
Phase 24 complete, ready for Phase 25 (Affect Detection)
</output>
