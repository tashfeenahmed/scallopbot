---
phase: 24-heartbeat-tier-enhancements
plan: 01
type: tdd
---

<objective>
Implement health ping and retrieval audit as pure functions with full TDD.

Purpose: Create the two diagnostic operations that monitor system health (sync health ping for lightTick) and memory utilization (async retrieval audit for deepTick). These are foundational signals for all other v4.0 phases.
Output: `src/memory/health-ping.ts` and `src/memory/retrieval-audit.ts` with tests, following v3.0 stateless pure function pattern.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-heartbeat-tier-enhancements/24-RESEARCH.md

@src/memory/memory.ts
@src/memory/db.ts
@src/memory/behavioral-signals.ts

**Tech stack available:** better-sqlite3, pino, node:os (all existing)
**Established patterns:** stateless pure functions (fusion.ts, behavioral-signals.ts), cold-start null return, try-catch per deep tick step
**Constraining decisions:**
- Phase 22: _sig_ prefix in response_preferences for signal storage
- Phase 22: Stateless pure functions pattern for all new memory operations
- Research: Health ping must be sync-only (no network calls in lightTick)
- Research: Retrieval audit should audit-and-log only (Phase 29 implements utility-based forgetting)
- Research: Only audit memories older than 7 days to avoid false positives
</context>

<feature>
  <name>Health Ping</name>
  <files>src/memory/health-ping.ts, src/memory/health-ping.test.ts</files>
  <behavior>
    performHealthPing(db) returns HealthPingResult:
    - walSizeBytes: number from PRAGMA wal_checkpoint(PASSIVE)
    - memoryCount: number from SELECT COUNT(*) WHERE is_latest=1
    - processMemoryMB: number from process.memoryUsage().heapUsed / 1048576
    - timestamp: Date.now()

    Cases:
    - Normal DB → returns all metrics with positive values
    - Empty DB → memoryCount = 0, walSizeBytes ≥ 0
    - All values are numbers, no NaN
  </behavior>
  <implementation>
    Pure function taking ScallopDatabase. Use db.raw() for WAL pragma and COUNT query.
    Use process.memoryUsage().heapUsed for memory. All sync — no async, no network.
    Do NOT include provider availability check (that's async, goes in deepTick per research pitfall #1).
  </implementation>
</feature>

<feature>
  <name>Retrieval Audit</name>
  <files>src/memory/retrieval-audit.ts, src/memory/retrieval-audit.test.ts</files>
  <behavior>
    auditRetrievalHistory(db, options?) returns RetrievalAuditResult:
    - neverRetrieved: count of active memories (prominence >= 0.5, is_latest=1) with access_count=0 AND age > minAgeDays
    - staleRetrieved: count of active memories with last_accessed older than staleThresholdDays (default 30)
    - totalAudited: total active memories checked
    - candidatesForDecay: string[] of memory IDs (neverRetrieved + staleRetrieved)

    Options: { minAgeDays?: number (default 7), staleThresholdDays?: number (default 30) }

    Cases:
    - Empty DB → all zeros, empty array
    - All memories recently accessed → neverRetrieved=0, staleRetrieved=0
    - Memory created 1 day ago, never accessed → NOT flagged (too young, minAgeDays=7)
    - Memory created 10 days ago, never accessed → flagged as neverRetrieved
    - Memory accessed 45 days ago, prominence 0.6 → flagged as staleRetrieved
    - Memory with prominence 0.3 → NOT audited (below 0.5 threshold)
  </behavior>
  <implementation>
    Pure function taking ScallopDatabase. Single SQL query with WHERE prominence >= 0.5 AND is_latest = 1 AND document_date < (now - minAgeDays).
    Split results in JS: access_count=0 → neverRetrieved, last_accessed < staleThreshold → staleRetrieved.
    Return audit-only results (no mutation). Phase 29 will consume candidatesForDecay.
  </implementation>
</feature>

<verification>
- `npx vitest run src/memory/health-ping.test.ts` — all tests pass
- `npx vitest run src/memory/retrieval-audit.test.ts` — all tests pass
- `npx vitest run` — no regressions in existing tests
</verification>

<success_criteria>
- Failing tests written and committed for both features
- Implementations pass all tests
- Refactor complete (if needed)
- Health ping is fully synchronous (no async/await)
- Retrieval audit respects minAgeDays to avoid false positives
- Both functions are pure (no side effects beyond DB reads)
- All commits present (2-3 per feature)
</success_criteria>

<output>
After completion, create `.planning/phases/24-heartbeat-tier-enhancements/24-01-SUMMARY.md`
</output>
