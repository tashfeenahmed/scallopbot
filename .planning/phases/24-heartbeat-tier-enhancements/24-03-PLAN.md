---
phase: 24-heartbeat-tier-enhancements
plan: 03
type: tdd
---

<objective>
Implement goal deadline checking as a pure function with full TDD.

Purpose: Create the deadline checker that scans active goals for approaching deadlines and produces notification candidates, deduplicated against existing scheduled items. This is the goal-awareness component of the heartbeat that enables proactive reminders (Phase 31-32).
Output: `src/memory/goal-deadline-check.ts` with tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-heartbeat-tier-enhancements/24-RESEARCH.md

@src/goals/goal-service.ts
@src/goals/types.ts
@src/memory/db.ts

**Tech stack available:** better-sqlite3 (existing)
**Established patterns:** GoalService.listGoals() for fetching goals, hasSimilarPendingScheduledItem() for dedup, pure function pattern
**Constraining decisions:**
- Research: Check goals with dueDate within warningWindowDays (default 7 days)
- Research: Deduplicate via hasSimilarPendingScheduledItem() to prevent spam (pitfall #5)
- Research: Only check 'active' status goals (not backlog, completed, or abandoned)
</context>

<feature>
  <name>Goal Deadline Check</name>
  <files>src/memory/goal-deadline-check.ts, src/memory/goal-deadline-check.test.ts</files>
  <behavior>
    checkGoalDeadlines(goals, existingReminders, options?) returns GoalDeadlineResult:

    Inputs:
    - goals: Array of GoalItem (pre-filtered to active goals with dueDates)
    - existingReminders: Array of { message: string } (pending scheduled items for dedup)
    - options?: { warningWindowDays?: number (default 7), now?: number }

    Output GoalDeadlineResult:
    - approaching: Array of { goalId, goalTitle, dueDate, daysRemaining, urgency: 'warning' | 'urgent' | 'overdue' }
    - notifications: Array of { userId, message, goalId } — deduped notifications to create
    - totalChecked: number

    Urgency mapping:
    - daysRemaining < 0 → 'overdue'
    - daysRemaining <= 2 → 'urgent'
    - daysRemaining <= warningWindowDays → 'warning'

    Cases:
    - No goals with dueDates → empty results
    - Goal due in 3 days → urgency 'warning', notification created
    - Goal due tomorrow → urgency 'urgent', notification created
    - Goal overdue by 2 days → urgency 'overdue', notification created
    - Goal due in 3 days but similar reminder already exists → NO duplicate notification
    - Goal due in 30 days → not included (outside window)
    - Goal with no dueDate → skipped
    - Multiple goals approaching → all included, each with own notification
  </behavior>
  <implementation>
    Pure function — no DB access. Caller provides pre-fetched goals and existing reminders.
    1. Filter goals to those with dueDate within warningWindowDays of now
    2. Compute daysRemaining and urgency for each
    3. Generate notification message: "Goal approaching deadline: {title} — due in {days} days" (or "overdue by {days} days")
    4. Deduplicate: check if any existing reminder message has >80% word overlap with generated message (reimplement simple word overlap, don't import db.ts)
    5. Return approaching goals and deduped notifications

    Word overlap dedup: split both messages into word sets, compute |intersection| / |smaller set|. If >= 0.8, it's a duplicate.
    This mirrors hasSimilarPendingScheduledItem() logic but as a pure function.
  </implementation>
</feature>

<verification>
- `npx vitest run src/memory/goal-deadline-check.test.ts` — all tests pass
- `npx vitest run` — no regressions
</verification>

<success_criteria>
- Failing tests written and committed
- Implementation passes all tests
- Urgency mapping correct at boundaries (0, 2, 7 days)
- Deduplication prevents spam for same goal
- Pure function with no side effects
- All commits present (2-3)
</success_criteria>

<output>
After completion, create `.planning/phases/24-heartbeat-tier-enhancements/24-03-SUMMARY.md`
</output>
