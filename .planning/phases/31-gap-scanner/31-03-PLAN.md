---
phase: 31-gap-scanner
plan: 03
type: tdd
---

<objective>
Build the Stage 3 proactiveness-gated action creation — takes DiagnosedGap[] and produces GapAction[] (ready-to-insert scheduled items) filtered by the user's proactiveness dial, severity thresholds, deduplication, and daily budget caps.

Purpose: Prevents notification fatigue by gating which diagnosed gaps actually become user-visible notifications. Conservative users see only critical gaps; eager users see more.
Output: gap-actions.ts with createGapActions and DIAL_THRESHOLDS, fully tested via TDD.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-gap-scanner/31-RESEARCH.md

# Key source files (established patterns):
@src/memory/goal-deadline-check.ts
@src/memory/trust-score.ts
@src/memory/db.ts

# Prior plans in this phase:
@.planning/phases/31-gap-scanner/31-01-SUMMARY.md
@.planning/phases/31-gap-scanner/31-02-SUMMARY.md

**Tech stack available:** DiagnosedGap from 31-02, GapSignal from 31-01, ScheduledItem types from db.ts
**Established patterns:** Word overlap dedup (goal-deadline-check.ts), proactivenessDial from trust-score.ts, addScheduledItem API
**Constraining decisions:**
- Research: DIAL_THRESHOLDS with minSeverity, minConfidence, maxDailyNotifications, allowedTypes per dial
- Research: Hard cap per sleep tick (max 3 actions regardless of dial)
- Research: Dedup via word overlap against existing pending scheduled items
- Phase 24-03: wordOverlap function pattern (|intersection|/|smaller set| >= 0.8)
- db.ts: source must be 'user' | 'agent', type must be valid ScheduledItemType
</context>

<feature>
  <name>Proactiveness-Gated Gap Actions (Stage 3)</name>
  <files>src/memory/gap-actions.ts, src/memory/gap-actions.test.ts</files>
  <behavior>
    Core types:
    ```
    GapAction { gap: DiagnosedGap, scheduledItem: { userId: string, source: 'agent', type: 'follow_up', message: string, context: string, triggerAt: number } }
    DialConfig { minSeverity, minConfidence, maxDailyNotifications, allowedTypes }
    ```

    DIAL_THRESHOLDS:
    - conservative: minSeverity='high', minConfidence=0.7, maxDailyNotifications=1, allowedTypes=['approaching_deadline', 'stale_goal']
    - moderate: minSeverity='medium', minConfidence=0.5, maxDailyNotifications=3, allowedTypes=['approaching_deadline', 'stale_goal', 'unresolved_thread']
    - eager: minSeverity='low', minConfidence=0.3, maxDailyNotifications=5, allowedTypes=['approaching_deadline', 'stale_goal', 'unresolved_thread', 'behavioral_anomaly']

    createGapActions(diagnosed, dial, existingItems, options?):
    - Filter: not actionable → skip
    - Filter: confidence < minConfidence → skip
    - Filter: type not in allowedTypes → skip
    - Filter: severity below minSeverity → skip (severity rank: low=0, medium=1, high=2)
    - Dedup: word overlap >= 0.8 with any existing item message → skip
    - Budget: stop after maxDailyNotifications reached
    - Hard cap: max 3 actions per call regardless of dial
    - Each action: source='agent', type='follow_up', message=suggestedAction, context=JSON({gapType, sourceId}), triggerAt=now + 30min
    - Injectable `now` for deterministic testing
    - Returns GapAction[]

    Edge cases:
    - Empty diagnosed → []
    - All filtered out → []
    - More gaps than budget → returns up to budget limit
    - All duplicates → []
  </behavior>
  <implementation>
    Create src/memory/gap-actions.ts with:
    - Import DiagnosedGap from gap-diagnosis.ts
    - Import GapSignal from gap-scanner.ts (import type)
    - Export GapAction interface, DIAL_THRESHOLDS constant
    - Export createGapActions as pure function
    - Reimplement wordOverlap locally (same as goal-deadline-check.ts) to avoid coupling — it's a 10-line utility
    - severityRank helper: { low: 0, medium: 1, high: 2 }
    - Do NOT import from db.ts — keep pure. Caller provides existingItems as Array<{ message: string }>
    - Hard cap constant: MAX_ACTIONS_PER_TICK = 3
  </implementation>
</feature>

<verification>
npx vitest run src/memory/gap-actions.test.ts — all tests pass
npx tsc --noEmit — no type errors
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor if needed (REFACTOR)
- Conservative dial only passes high-severity, high-confidence gaps
- Moderate dial passes medium+ severity with broader types
- Eager dial passes low+ severity with all types
- Dedup correctly rejects word-overlap matches >= 0.8
- Budget caps enforced (per-dial + hard cap)
- All outputs have valid scheduledItem shape matching db.addScheduledItem requirements
</success_criteria>

<output>
After completion, create `.planning/phases/31-gap-scanner/31-03-SUMMARY.md`
</output>
