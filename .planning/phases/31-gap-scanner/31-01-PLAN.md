---
phase: 31-gap-scanner
plan: 01
type: tdd
---

<objective>
Build the Stage 1 gap signal heuristics — pure functions that scan existing data (goals, behavioral signals, session summaries) for unresolved threads, stale goals, and behavioral anomalies. Returns typed GapSignal[] for downstream LLM triage.

Purpose: Deterministic, testable gap detection that runs without LLM calls — the cheapest, most reliable part of the PROBE 3-stage pipeline.
Output: gap-scanner.ts with scanForGaps orchestrator + individual scanner functions, fully tested via TDD.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-gap-scanner/31-RESEARCH.md

# Key source files (established patterns):
@src/memory/goal-deadline-check.ts
@src/memory/behavioral-signals.ts
@src/memory/db.ts
@src/goals/types.ts

# Prior phase context:
@.planning/phases/24-heartbeat-tier-enhancements/24-03-SUMMARY.md
@.planning/phases/24-heartbeat-tier-enhancements/24-04-SUMMARY.md

**Tech stack available:** better-sqlite3, existing BehavioralPatterns/GoalItem/SessionSummaryRow types
**Established patterns:** Pure heuristic functions (goal-deadline-check.ts), word overlap dedup, injectable `now` for deterministic testing
**Constraining decisions:**
- Phase 24-03: Word overlap dedup pattern (|intersection|/|smaller set| >= 0.8)
- Phase 24-04: Plain keys for behavioral patterns (not _sig_ prefix)
- Research: Rule-based Stage 1, no LLM — heuristics are free and deterministic
</context>

<feature>
  <name>Gap Signal Heuristics (Stage 1)</name>
  <files>src/memory/gap-scanner.ts, src/memory/gap-scanner.test.ts</files>
  <behavior>
    Core types:
    ```
    GapSignal { type, severity, description, context, sourceId }
    GapScanInput { activeGoals, behavioralSignals, sessionSummaries, now? }
    ```

    scanStaleGoals(goals, now):
    - Goal with no dueDate and metadata.updatedAt > 14 days ago → 'stale_goal', severity 'medium'
    - Goal with dueDate passed and status still 'active' → 'stale_goal', severity 'high'
    - Goal with checkinFrequency and days_since_update / checkinFrequencyDays > 3.0 → 'stale_goal', severity 'medium'
    - Goal updated within window → no signal
    - Empty goals array → []

    scanBehavioralAnomalies(signals, now):
    - signals.messageFrequency null → [] (cold start, skip)
    - messageFrequency.trend === 'decreasing' AND dailyRate < weeklyAvg * 0.5 → 'behavioral_anomaly', severity 'low', description mentions frequency drop
    - sessionEngagement.trend === 'decreasing' AND avgMessagesPerSession < 3 → 'behavioral_anomaly', severity 'low'
    - responseLength.trend === 'decreasing' (3+ consecutive) → 'behavioral_anomaly', severity 'low'
    - No anomaly conditions met → []

    scanUnresolvedThreads(summaries, now):
    - Summary with topics containing "?" (question indicator) AND no subsequent summary within 48h AND age < 7 days → 'unresolved_thread', severity 'medium'
    - Summary with messageCount < 3 AND age < 48h → skip (too fresh/short to judge)
    - All resolved or old → []

    scanForGaps(input) orchestrator:
    - Calls all sub-scanners, concatenates results
    - Returns GapSignal[]
  </behavior>
  <implementation>
    Create src/memory/gap-scanner.ts with:
    - Export GapSignal, GapScanInput interfaces
    - Export scanStaleGoals, scanBehavioralAnomalies, scanUnresolvedThreads as individual pure functions
    - Export scanForGaps as orchestrator that calls all sub-scanners
    - Use GoalItem from goals/types.ts (import type)
    - Use BehavioralPatterns from db.ts (import type)
    - Use SessionSummaryRow from db.ts (import type)
    - Injectable `now` parameter (default Date.now()) for deterministic testing
    - checkinFrequency conversion: 'daily'=1, 'weekly'=7, 'biweekly'=14, 'monthly'=30
    - Do NOT implement missed_commitment detection yet (deferred to Phase 32 — requires raw message scanning which is expensive). Only implement stale_goals, behavioral_anomaly, unresolved_thread.
    - Do NOT use LLM calls — all heuristics are pure computation
  </implementation>
</feature>

<verification>
npx vitest run src/memory/gap-scanner.test.ts — all tests pass
npx tsc --noEmit — no type errors
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor if needed (REFACTOR)
- scanForGaps returns correct GapSignal[] for all documented input scenarios
- All 3 sub-scanners individually tested
- Cold start / empty input cases handled gracefully
- No LLM calls in any function
</success_criteria>

<output>
After completion, create `.planning/phases/31-gap-scanner/31-01-SUMMARY.md`
</output>
