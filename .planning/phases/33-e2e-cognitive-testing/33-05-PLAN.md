---
phase: 33-e2e-cognitive-testing
plan: 05
type: execute
---

<objective>
Full cognitive cycle E2E test: multi-turn conversation triggering affect â†’ deepTick (trust, forgetting, inner thoughts) â†’ sleepTick (dream, reflection, gaps) end-to-end. Plus per-channel proactive message formatting.

Purpose: Validate the complete v4.0 cognitive pipeline in a single integrated test â€” a conversation triggers affect classification, deepTick processes behavioral signals and inner thoughts, sleepTick runs dreams and gap scanning. Also validate per-channel formatting for proactive messages.
Output: New E2E test file `src/e2e/cognitive-full-cycle.test.ts` with 2 passing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/e2e/helpers.ts
@src/e2e/full-flow.test.ts

# Source modules under test:
@src/memory/memory.ts
@src/memory/affect.ts
@src/memory/affect-smoothing.ts
@src/memory/dream.ts
@src/memory/reflection.ts
@src/memory/gap-scanner.ts
@src/memory/inner-thoughts.ts
@src/proactive/proactive-format.ts
@src/agent/agent.ts

**Key integration:**
- Full cycle: WebSocket chat â†’ processMessage (affect) â†’ deepTick (trust, forgetting, behavioral, inner thoughts) â†’ sleepTick (dream, reflection, gaps)
- Per-channel formatting: formatProactiveForTelegram (icon + truncation + footer), formatProactiveForWebSocket (structured JSON with type, message, metadata)
- WsResponse 'proactive' type for WebSocket channel

**Mock provider response sequence:**
The fusionProvider will be called multiple times across deepTick and sleepTick. Need to provide enough mock responses in sequence:
1. Agent response for chat message
2. Fact extraction response (if factExtractorResponses provided)
3. deepTick inner thoughts: `{ "decision": "proact", ... }`
4. sleepTick NREM: `{ "summary": "...", "importance": 6, "category": "insight" }`
5. sleepTick REM judge: `{ "novelty": 0.3, ... }` (low â€” no discovery)
6. sleepTick reflection: `{ "reflections": [...] }`
7. sleepTick soul distillation: raw markdown
8. sleepTick gap diagnosis: `{ "diagnoses": [...] }`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full cognitive cycle integration test</name>
  <files>src/e2e/cognitive-full-cycle.test.ts</files>
  <action>
Create new E2E test file.

**Suite 1: "full cognitive cycle: chat â†’ deepTick â†’ sleepTick"**

This is a comprehensive integration test that exercises the entire v4.0 pipeline.

Setup:
- Use createE2EGateway with:
  - responses: ['I can help you with that async pattern! [DONE]']
  - factExtractorResponses: ['{ "facts": [{ "content": "User is learning async patterns", "category": "fact", "importance": 6 }] }']
- Create BackgroundGardener separately (createE2EGateway doesn't create one) with:
  - scallopStore from gateway context
  - fusionProvider: createMockLLMProvider with responses covering inner thoughts + dream + reflection + gap diagnosis (8+ responses in cycle order)
  - workspace: temp directory
- Seed prerequisite data:
  - 6+ session summaries with recent createdAt (for trust score cold-start, inner thoughts, reflection)
  - 3+ scheduled items with status 'acted' (for trust computation)
  - An active goal with updatedAt 14 days ago (for gap scanner)
  - Behavioral patterns with moderate dial, calm affect

Phase 1 â€” Chat interaction:
- Connect WebSocket client
- Send chat message: "I'm really excited to learn about async/await patterns in JavaScript!"
- Collect response via collectUntilResponse
- Wait 2s for async fact extraction
- Assert: smoothedAffect persisted (check profileManager â€” valence should be positive from "excited")

Phase 2 â€” Deep tick:
- Call gardener.deepTick()
- Assert: trust score computed (responsePreferences.trustScore exists)
- Assert: behavioral patterns updated (messageFrequency not null)
- Check if inner thoughts created a scheduled item (may or may not depending on mock response order)

Phase 3 â€” Sleep tick:
- Call gardener.sleepTick()
- Assert: at least one of: derived memory (from NREM), insight memory (from reflection), or scheduled item (from gap scanner) was created
- This validates the full nightly cognitive processing pipeline

The test doesn't need every single assertion to pass perfectly â€” the goal is to verify the pipeline runs without errors and produces observable side effects. Use soft assertions where stochastic elements are involved.
  </action>
  <verify>npm test -- src/e2e/cognitive-full-cycle.test.ts â€” Suite 1 passes</verify>
  <done>Full cognitive cycle runs without errors: chat triggers affect, deepTick processes heartbeat features, sleepTick runs dream+reflection+gaps</done>
</task>

<task type="auto">
  <name>Task 2: Add per-channel proactive formatting test</name>
  <files>src/e2e/cognitive-full-cycle.test.ts</files>
  <action>
Add second test suite validating per-channel proactive message formatting.

**Suite 2: "per-channel proactive message formatting"**

This is a lightweight test (no WebSocket needed) â€” direct function calls.

Setup:
- Import formatProactiveForTelegram, formatProactiveForWebSocket, formatProactiveMessage from '../proactive/proactive-format.js'
- Create test input: { message: 'I noticed you were working on async patterns. Need help?', gapType: 'follow_up', urgency: 'medium', source: 'inner_thoughts' }

Tests:
1. **Telegram format:**
   - Call formatProactiveForTelegram(input)
   - Assert result is a string
   - Assert result contains an emoji/icon (ðŸ’¡ or similar)
   - Assert result contains the message text
   - Assert result contains a footer or source indicator

2. **WebSocket format:**
   - Call formatProactiveForWebSocket(input)
   - Assert result is an object (not string)
   - Assert result has 'type' field (should be 'proactive' or similar)
   - Assert result has 'message' field containing the original message
   - Assert result has metadata (urgency, source, gapType)

3. **Channel routing:**
   - Call formatProactiveMessage(input, 'telegram') â†’ should return string
   - Call formatProactiveMessage(input, 'websocket') â†’ should return object
   - Verify the router picks the correct formatter based on channel type

This validates the per-channel formatting established in Phase 32.
  </action>
  <verify>npm test -- src/e2e/cognitive-full-cycle.test.ts â€” both suites pass</verify>
  <done>Per-channel formatting produces correct Telegram text and WebSocket structured JSON for proactive messages</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete v4.0 E2E cognitive test suite across 5 plans: affect+heartbeat, dream cycle, reflection+gaps, inner thoughts+feedback, full cycle+formatting</what-built>
  <how-to-verify>
    1. Run: `npm test -- src/e2e/cognitive` to execute all new E2E tests
    2. Verify all tests pass (expected: 13+ test suites across 5 files)
    3. Run: `npm test` to verify no existing tests broken
    4. Check test output for reasonable execution times (<60s per file)
    5. Confirm no TypeScript errors: `npx tsc --noEmit`
  </how-to-verify>
  <resume-signal>Type "approved" to continue to phase completion, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/e2e/cognitive-full-cycle.test.ts` passes all tests
- [ ] `npm test -- src/e2e/cognitive` passes ALL new cognitive E2E tests
- [ ] `npm test` passes all existing tests (no regressions)
- [ ] `npx tsc --noEmit` succeeds
- [ ] No TypeScript errors in new test files
</verification>

<success_criteria>

- Full cognitive cycle test validates end-to-end pipeline without errors
- Per-channel formatting produces correct output for Telegram and WebSocket
- All v4.0 E2E tests pass together
- No regressions in existing test suite
- Phase 33 complete â€” v4.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/33-e2e-cognitive-testing/33-05-SUMMARY.md`

Additionally, since this is the final phase of v4.0, the summary should note:
- Total new E2E tests added
- All v4.0 features validated
- v4.0 milestone readiness
</output>
