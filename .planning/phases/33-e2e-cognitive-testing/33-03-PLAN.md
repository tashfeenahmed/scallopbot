---
phase: 33-e2e-cognitive-testing
plan: 03
type: execute
---

<objective>
E2E tests for self-reflection (SOUL.md generation) and the gap scanner 3-stage pipeline.

Purpose: Validate that sleepTick runs self-reflection producing insight memories and updating SOUL.md, and that the gap scanner detects stale goals / unresolved threads and creates scheduled items gated by proactiveness dial.
Output: New E2E test file `src/e2e/cognitive-reflection-gaps.test.ts` with 3 passing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/e2e/helpers.ts
@src/e2e/memory-lifecycle.test.ts

# Source modules under test:
@src/memory/reflection.ts
@src/memory/gap-scanner.ts
@src/memory/gap-diagnosis.ts
@src/memory/gap-actions.ts
@src/memory/memory.ts

**Key integration points:**
- Reflection: sleepTick after dream cycle → reflect(todaySummaries, currentSoul, fusionProvider)
  - Gated on fusionProvider AND workspace
  - Stores insight memories (category='insight', learnedFrom='self_reflection', memoryType='derived')
  - Writes SOUL.md to workspace directory
  - Reflection prompt: expects JSON with reflections array [{type, content, topics, sessionIds}]
  - Soul distillation prompt: expects raw markdown text

- Gap scanner: sleepTick Phase 31 section
  - Stage 1: scanForGaps(activeGoals, behavioralSignals, sessionSummaries) → GapSignal[]
  - Stage 2: diagnoseGaps(signals, userContext, provider) → DiagnosedGap[]
  - Stage 3: createGapActions(diagnosed, dial, existingItems) → GapAction[]
  - Creates scheduled_items with source='agent', type='follow_up'
  - Uses computeDeliveryTime for timing

**Mock provider responses needed:**
- Reflection: JSON with reflections array: `{ "reflections": [{ "type": "Composite", "content": "...", "topics": [...], "sessionIds": [...] }] }`
- Soul distillation: raw markdown text
- Gap diagnosis: JSON with diagnoses array: `{ "diagnoses": [{ "signal_index": 0, "diagnosis": "...", "actionable": true, "suggested_action": "...", "confidence": 0.8, "severity": "medium" }] }`
- NREM/REM responses also needed since dream runs before reflection in sleepTick
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create self-reflection E2E test via sleepTick</name>
  <files>src/e2e/cognitive-reflection-gaps.test.ts</files>
  <action>
Create new E2E test file.

**Suite 1: "self-reflection via sleepTick"**

Setup:
- Create temp workspace directory (os.tmpdir() + random suffix)
- Create ScallopMemoryStore + BackgroundGardener with fusionProvider AND workspace
- fusionProvider mock responses (will be called for dream cycle first, then reflection):
  1-2. NREM/REM responses (empty/minimal — dream cycle may not produce results if no qualifying memories, but provider still needs responses ready)
  3. Reflection response: `{ "reflections": [{ "type": "Composite", "content": "I notice the user consistently works on TypeScript projects and asks about testing patterns. They value clean code and TDD.", "topics": ["typescript", "testing", "tdd"], "sessionIds": ["sess-1", "sess-2"] }] }`
  4. Soul distillation response: raw markdown: "# SOUL\n\nI am a coding assistant who helps with TypeScript and testing. I emphasize clean code practices and TDD methodology."
- Seed 2+ session summaries via db.addSessionSummary with createdAt within last 24 hours (so they qualify for reflection)
  - Session 1: summary about TypeScript patterns, 6 messages
  - Session 2: summary about testing best practices, 4 messages
- Do NOT seed memories with old dates (avoid triggering NREM — keep dream cycle lightweight)

Test:
- Call gardener.sleepTick()
- Assert insight memory exists: query memories where category='insight' AND learnedFrom='self_reflection'
- Assert insight content contains reflection text
- Assert insight metadata has sourceSessionIds
- Assert insight memoryType is 'derived'
- Assert SOUL.md was written to workspace: read file and verify content contains "SOUL" or "TypeScript"
- Verify SOUL.md is valid markdown (not JSON)

Cleanup: remove temp workspace dir in afterAll.
  </action>
  <verify>npm test -- src/e2e/cognitive-reflection-gaps.test.ts -- self-reflection passes</verify>
  <done>Self-reflection generates insight memories and writes SOUL.md via sleepTick</done>
</task>

<task type="auto">
  <name>Task 2: Add gap scanner pipeline E2E tests via sleepTick</name>
  <files>src/e2e/cognitive-reflection-gaps.test.ts</files>
  <action>
Add 2 more test suites to same file.

**Suite 2: "gap scanner detects stale goals via sleepTick"**

Setup:
- Create fresh ScallopMemoryStore + BackgroundGardener with fusionProvider (workspace optional)
- fusionProvider mock responses:
  1-4. Dream + reflection responses (minimal/empty to pass through)
  5. Gap diagnosis response: `{ "diagnoses": [{ "signal_index": 0, "diagnosis": "Goal has not been updated in over a week", "actionable": true, "suggested_action": "Check in about progress on learning Rust", "confidence": 0.85, "severity": "medium" }] }`
- Seed an active goal with GoalService:
  - Dynamic import GoalService
  - Create goal: title "Learn Rust programming", status 'active', updatedAt = 14 days ago (stale)
  - No dueDate needed (stale detection is based on updatedAt age)
- Seed 2+ session summaries (needed for scanForGaps input)
- Seed behavioral patterns with proactivenessDial = 'moderate' (default threshold)

Test:
- Call gardener.sleepTick()
- Query scheduled_items where source='agent' AND type='follow_up'
- Assert at least one scheduled item exists
- Assert item message references learning Rust or the goal
- Assert item has context JSON with source information

**Suite 3: "gap scanner respects conservative dial"**

Setup:
- Same as Suite 2 but set proactivenessDial = 'conservative'
- Seed a low-severity gap (goal updated 8 days ago — borderline stale)
- fusionProvider gap diagnosis returns severity: 'low', confidence: 0.5

Test:
- Call gardener.sleepTick()
- Query scheduled_items where source='agent' AND type='follow_up'
- Assert NO scheduled items created (conservative dial filters low-severity, low-confidence gaps)
- This validates the proactiveness gating — conservative dial requires high severity + high confidence

For GoalService seeding: check if GoalService.createGoal or db has a direct addGoal method. If GoalService requires specific constructor args, use `new GoalService({ db, logger })` pattern from memory.ts.
  </action>
  <verify>npm test -- src/e2e/cognitive-reflection-gaps.test.ts — all 3 suites pass</verify>
  <done>Gap scanner creates scheduled items for stale goals, conservative dial correctly filters low-severity gaps</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/e2e/cognitive-reflection-gaps.test.ts` passes all tests
- [ ] No TypeScript errors
- [ ] Tests run in <60s total
- [ ] Tests clean up temp DB files and temp workspace dirs
</verification>

<success_criteria>

- Self-reflection produces insight memories with correct metadata via sleepTick
- SOUL.md written to workspace directory
- Gap scanner creates scheduled items for stale goals
- Conservative dial correctly filters low-severity gaps
- All tests deterministic with mock providers
</success_criteria>

<output>
After completion, create `.planning/phases/33-e2e-cognitive-testing/33-03-SUMMARY.md`
</output>
