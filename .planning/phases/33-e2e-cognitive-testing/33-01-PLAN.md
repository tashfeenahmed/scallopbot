---
phase: 33-e2e-cognitive-testing
plan: 01
type: execute
---

<objective>
E2E tests for affect detection pipeline and heartbeat tier enhancements (trust score, goal deadlines, enhanced forgetting).

Purpose: Validate that per-message affect classification flows through processMessage into behavioral patterns and system prompt context, and that deepTick correctly computes trust scores, checks goal deadlines, and runs utility-based forgetting.
Output: New E2E test file `src/e2e/cognitive-affect-heartbeat.test.ts` with 4 passing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing E2E infrastructure:
@src/e2e/helpers.ts
@src/e2e/memory-lifecycle.test.ts

# Source modules under test:
@src/memory/affect.ts
@src/memory/affect-smoothing.ts
@src/memory/trust-score.ts
@src/memory/goal-deadline-check.ts
@src/memory/utility-score.ts
@src/memory/memory.ts
@src/agent/agent.ts
@src/routing/context.ts

**Established patterns:**
- Direct component wiring (no Gateway class) for custom mock providers
- createMockLLMProvider/createMockEmbeddingProvider from helpers.ts
- BackgroundGardener instantiated with scallopStore + fusionProvider for deepTick tests
- ScallopMemoryStore.getDatabase() for direct DB assertions
- db.addMemory() for seeding with old documentDate values
- ProfileManager for behavioral pattern queries
- 30000ms test timeouts, pino({ level: 'silent' })

**Key integration points:**
- classifyAffect() called in agent.processMessage via dynamic import (agent.ts:266-279)
- Affect stored in profileManager.updateBehavioralPatterns as affectState + smoothedAffect
- Trust score computed in deepTick step 5 → responsePreferences.trustScore + proactivenessDial
- Goal deadline check in deepTick step 6 → scheduled_items with type 'goal_checkin'
- Utility-based forgetting in deepTick step 3b → archives low-utility memories
- Affect context injected via ContextManager → system prompt contains "USER AFFECT CONTEXT"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test file with affect detection + context injection tests</name>
  <files>src/e2e/cognitive-affect-heartbeat.test.ts</files>
  <action>
Create new E2E test file following memory-lifecycle.test.ts patterns (direct component wiring, no WebSocket needed for most tests).

**Suite 1: "affect detection via processMessage"**
- Use createE2EGateway with factExtractorResponses (to allow processMessage to run end-to-end)
- Send a happy message via WebSocket ("I'm so excited about this amazing project!")
- After response, query profileManager.getBehavioralPatterns('default')
- Assert affectState is not null (EMA state was persisted)
- Assert smoothedAffect is not null with emotion label (should be 'excited' or 'happy' based on AFINN valence)
- Assert smoothedAffect.valence > 0 (positive message)

**Suite 2: "affect context in system prompt"**
- Reuse gateway from Suite 1 or create fresh one
- Seed affectState via profileManager.updateBehavioralPatterns('default', { smoothedAffect: { valence: 0.6, arousal: 0.5, emotion: 'happy', goalSignal: 'user_engaged' } })
- Send a second message via WebSocket
- Inspect mockProvider.lastRequest.system — assert it contains 'USER AFFECT CONTEXT' or 'happy' or 'engaged'
- Assert system prompt does NOT contain the affect guard violation (should NOT contain 'change your tone' — only observation)

Use createWsClient for WebSocket interaction. Wait for collectUntilResponse, then check DB state.
  </action>
  <verify>npm test -- src/e2e/cognitive-affect-heartbeat.test.ts — first 2 suites pass</verify>
  <done>Affect detection persists affectState+smoothedAffect to behavioral patterns after processMessage, and affect context appears in system prompt as observation block</done>
</task>

<task type="auto">
  <name>Task 2: Add trust score, goal deadline, and enhanced forgetting E2E tests</name>
  <files>src/e2e/cognitive-affect-heartbeat.test.ts</files>
  <action>
Add 3 more test suites to the same file. These use direct component wiring (no WebSocket needed — call deepTick directly).

**Suite 3: "trust score computation via deepTick"**
- Create ScallopMemoryStore + BackgroundGardener (with fusionProvider for inner-thoughts gating)
- Seed 6+ session summaries via db.addSessionSummary (enough to exceed cold-start threshold of 5)
- Seed 3+ scheduled items with status 'acted' and source 'agent' (proactive acceptance signal)
- Call gardener.deepTick()
- Query profileManager.getBehavioralPatterns('default').responsePreferences
- Assert trustScore is a number > 0
- Assert proactivenessDial is one of 'conservative', 'moderate', 'eager'

**Suite 4: "goal deadline check via deepTick"**
- Same setup pattern, plus seed an active goal with dueDate = now + 2 days (approaching)
- Use GoalService to create the goal (or seed directly via db if goal table accessible)
- Call gardener.deepTick()
- Query db for scheduled items with type 'goal_checkin'
- Assert at least one scheduled item exists with message containing the goal reference
- Verify no duplicate items created on second deepTick call

**Suite 5: "utility-based forgetting via deepTick"**
- Seed memories with old documentDate (60+ days), low importance, accessCount=0
- These will have low utility scores: prominence × ln(1 + 0) = 0
- Also seed memories with high accessCount (should survive)
- Call gardener.deepTick()
- Assert low-utility memories are archived (is_latest=0, memory_type='superseded')
- Assert high-access memories remain active

For goal deadline: dynamically import GoalService and use its create method. If GoalService requires specific setup, check the goal-service module for constructor signature and seed goals via db.addGoal or similar.
  </action>
  <verify>npm test -- src/e2e/cognitive-affect-heartbeat.test.ts — all 5 suites pass</verify>
  <done>Trust score computed and persisted after deepTick, goal deadline creates scheduled items, utility-based forgetting archives low-access old memories</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/e2e/cognitive-affect-heartbeat.test.ts` passes all tests
- [ ] No TypeScript errors in new test file
- [ ] Tests run in <60s total
- [ ] Tests clean up temp DB files
</verification>

<success_criteria>

- All 5 test suites pass
- Affect detection → persistence → system prompt injection validated E2E
- Trust score computation validated E2E
- Goal deadline check creates scheduled items
- Utility-based forgetting archives low-utility memories
- No flaky tests (deterministic mock providers)
</success_criteria>

<output>
After completion, create `.planning/phases/33-e2e-cognitive-testing/33-01-SUMMARY.md`
</output>
