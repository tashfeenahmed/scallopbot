---
phase: 33-e2e-cognitive-testing
plan: 02
type: execute
---

<objective>
E2E tests for the dream cycle: NREM cross-category consolidation and REM stochastic exploration.

Purpose: Validate that sleepTick runs the full dream cycle — NREM consolidation produces derived memories with cross-category insight override, and REM exploration creates EXTENDS relations for novel connections.
Output: New E2E test file `src/e2e/cognitive-dream.test.ts` with 2 passing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/e2e/helpers.ts
@src/e2e/memory-lifecycle.test.ts

# Source modules under test:
@src/memory/dream.ts
@src/memory/nrem-consolidation.ts
@src/memory/rem-exploration.ts
@src/memory/memory.ts

**Established patterns:**
- memory-lifecycle.test.ts shows the deepTick fusion pattern: seed memories with old dates via db.addMemory(), connect with EXTENDS relations, call gardener.deepTick(), assert derived memory + superseded originals
- sleepTick uses wider prominence window [0.05, 0.8) vs deepTick's [0.1, 0.7)
- NREM: crossCategory clustering via dream() orchestrator → derived memories with learnedFrom 'nrem_consolidation'
- REM: sampleSeeds → spreading activation → LLM judge → EXTENDS relations (no new memories)
- fusionProvider drives both NREM and REM (same mock provider)
- Dream orchestrator: dream(memories, getRelations, nremProvider, remProvider, config?)

**Key differences from existing memory-lifecycle fusion test:**
- sleepTick calls dream() orchestrator (not raw findFusionClusters + fuseMemoryCluster)
- Cross-category clustering: seed memories from different categories that form cluster
- NREM overrides cross-category clusters to category 'insight'
- REM stores EXTENDS relations only (not new memories)
- REM LLM judge response format: JSON with novelty, plausibility, usefulness scores

**Mock provider responses needed:**
- NREM: JSON with summary, importance, category fields
- REM judge: JSON with novelty, plausibility, usefulness (each 0-1), connectionDescription, confidence
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NREM consolidation E2E test via sleepTick</name>
  <files>src/e2e/cognitive-dream.test.ts</files>
  <action>
Create new E2E test file following memory-lifecycle.test.ts patterns.

**Suite 1: "NREM consolidation via sleepTick"**

Setup:
- Create ScallopMemoryStore + BackgroundGardener with fusionProvider and workspace (temp dir)
- fusionProvider returns two responses in sequence:
  1. NREM fusion: `{ "summary": "User has a cross-domain interest connecting cooking and chemistry", "importance": 7, "category": "insight" }`
  2. REM judge: `{ "novelty": 0.3, "plausibility": 0.9, "usefulness": 0.4, "connectionDescription": "weak connection", "confidence": 0.3 }` (below threshold — no REM discoveries expected)
- Seed 4+ memories across two categories ('fact' and 'preference') with old documentDate (60 days), low prominence (0.15-0.4), and EXTENDS relations connecting them into a cluster
  - "User enjoys cooking Italian food" (category: preference)
  - "User studied organic chemistry in college" (category: fact)
  - "User mentioned molecular gastronomy interest" (category: fact)
  - "User likes experimenting with fermentation" (category: preference)
- Connect with EXTENDS relations to form one cluster spanning categories
- Key: prominence must be in [0.05, 0.8) window AND memories must not be static_profile or derived

Test:
- Call gardener.sleepTick()
- Assert a new derived memory exists with learnedFrom 'nrem_consolidation'
- Assert derived memory content references cross-domain topic
- Assert metadata.nrem is true
- Assert original 4 memories are marked superseded (memory_type='superseded', is_latest=0)
- Assert DERIVES relations exist from fused memory to each source
- Assert fused memory prominence <= 0.6 (capped)

This validates cross-category clustering (memories from different categories fused into single insight).
  </action>
  <verify>npm test -- src/e2e/cognitive-dream.test.ts -- NREM passes</verify>
  <done>NREM consolidation produces cross-category derived memory via sleepTick, originals superseded, DERIVES relations stored</done>
</task>

<task type="auto">
  <name>Task 2: Add REM exploration E2E test via sleepTick</name>
  <files>src/e2e/cognitive-dream.test.ts</files>
  <action>
Add second test suite to same file.

**Suite 2: "REM exploration via sleepTick"**

Setup:
- Create fresh ScallopMemoryStore + BackgroundGardener with fusionProvider and workspace
- fusionProvider mock responses (cycled):
  1. NREM fusion response (for any NREM clusters that form): `{ "summary": "Travel and photography connection", "importance": 6, "category": "insight" }`
  2. REM judge response (positive — above threshold): `{ "novelty": 0.8, "plausibility": 0.7, "usefulness": 0.75, "connectionDescription": "Both involve capturing cultural experiences from different perspectives", "confidence": 0.75 }`
- Seed 6+ memories with old dates (60 days), prominence in [0.05, 0.8):
  - 3 about travel (category: 'fact'): "User visited Japan last summer", "User enjoys exploring local food markets", "User plans to visit Italy next year"
  - 3 about photography (category: 'preference'): "User loves street photography", "User has a mirrorless camera collection", "User photographs food regularly"
- Create EXTENDS relations within each group (to form 2 clusters for NREM, and give REM seeds)
- Importantly: do NOT create cross-group relations (REM should discover these)

Test:
- Call gardener.sleepTick()
- Query memory_relations table for EXTENDS relations that were NOT in the original seed
- Assert at least one new EXTENDS relation exists connecting a travel memory to a photography memory (or vice versa) — this is a REM discovery
- Assert the new relation has confidence > 0 (from LLM judge)
- Verify REM did not create new memory entries (only relations)

Note: REM is stochastic (random seed sampling), so the test may need to be tolerant of which specific memories get connected. Assert that ANY cross-group EXTENDS relation was created, not a specific one.

If stochasticity makes the test flaky, seed a smaller memory set (4 memories total, 2 per group) so the REM sampler is more likely to pick cross-group pairs. Or set noiseSigma high enough in the default config to ensure spread.
  </action>
  <verify>npm test -- src/e2e/cognitive-dream.test.ts — both suites pass</verify>
  <done>REM exploration discovers novel cross-topic connections stored as EXTENDS relations via sleepTick, no new memories created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/e2e/cognitive-dream.test.ts` passes all tests
- [ ] No TypeScript errors
- [ ] Tests run in <60s total
- [ ] Tests clean up temp DB files and temp workspace dirs
</verification>

<success_criteria>

- NREM cross-category consolidation validated E2E (derived memory, superseded originals, DERIVES relations)
- REM exploration validated E2E (novel EXTENDS relations, no new memories)
- Both tests use sleepTick (not direct module calls)
- No flaky tests
</success_criteria>

<output>
After completion, create `.planning/phases/33-e2e-cognitive-testing/33-02-SUMMARY.md`
</output>
