---
phase: 33-e2e-cognitive-testing
plan: 04
type: execute
---

<objective>
E2E tests for inner thoughts evaluation, delivery timing model, and proactive feedback loop.

Purpose: Validate that deepTick evaluates inner thoughts after sessions and creates timed scheduled items, and that the trust calibration feedback loop updates proactive acceptance rate.
Output: New E2E test file `src/e2e/cognitive-inner-thoughts.test.ts` with 3 passing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/e2e/helpers.ts
@src/e2e/memory-lifecycle.test.ts

# Source modules under test:
@src/memory/inner-thoughts.ts
@src/proactive/timing-model.ts
@src/proactive/feedback.ts
@src/memory/memory.ts

**Key integration points:**
- Inner thoughts: deepTick step 7
  - Gated on fusionProvider
  - Filters users by session summaries from last 6 hours
  - Calls evaluateInnerThoughts(input, provider) → decision: proact/wait/skip
  - If 'proact': creates scheduled_item with computed delivery time
  - Pre-filter: shouldRunInnerThoughts (6h cooldown, distress suppression, conservative-with-no-signals=skip)

- Timing model: computeDeliveryTime(context) → { deliverAt, reason, strategy }
  - 4-strategy priority: urgent_now > next_morning > active_hours > next_active
  - High urgency bypasses min gap but NOT quiet hours
  - Uses isInQuietHours standalone function

- Feedback loop: detectProactiveEngagement(userId, recentFiredItems, windowMs, now?)
  - 15-min engagement window
  - Returns IDs of items where user engaged within window
  - Trust score incorporates proactiveAcceptRate

**Mock provider responses needed:**
- Inner thoughts evaluation: JSON with decision, reason, message, urgency
  `{ "decision": "proact", "reason": "User mentioned struggling with async patterns", "message": "I noticed you were working on async/await patterns. Would you like me to explain some common pitfalls?", "urgency": "medium" }`

**Existing patterns from deepTick:**
- Behavioral patterns seeded via profileManager.updateBehavioralPatterns
- Session summaries seeded via db.addSessionSummary with recent createdAt
- Scheduled items queried via db.getScheduledItemsByUser
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inner thoughts evaluation E2E test via deepTick</name>
  <files>src/e2e/cognitive-inner-thoughts.test.ts</files>
  <action>
Create new E2E test file.

**Suite 1: "inner thoughts creates proactive scheduled item via deepTick"**

Setup:
- Create ScallopMemoryStore + BackgroundGardener with fusionProvider
- fusionProvider mock responses (deepTick calls multiple LLM steps):
  1. Inner thoughts evaluation: `{ "decision": "proact", "reason": "User was working on async patterns and seemed stuck", "message": "I noticed you were working on async/await patterns earlier. Would you like me to walk through some common pitfalls like error handling in Promise.all?", "urgency": "medium" }`
- Seed a session summary with createdAt = Date.now() (within 6h window) via db.addSessionSummary
  - summary: "User asked about async/await patterns and error handling"
  - topics: ['async', 'javascript']
  - messageCount: 5, durationMs: 300000
- Seed behavioral patterns via profileManager.updateBehavioralPatterns:
  - proactivenessDial: 'moderate'
  - smoothedAffect: { valence: 0.1, arousal: 0.3, emotion: 'calm', goalSignal: 'stable' } (NOT distressed)
  - messageFrequency: { dailyRate: 3, weeklyAvg: 15, trend: 'stable', lastComputed: Date.now() }
- Do NOT seed any recent 'fired' scheduled items (no 6h cooldown block)

Test:
- Call gardener.deepTick()
- Query db.getScheduledItemsByUser('default')
- Find item with source='agent' AND type='follow_up'
- Assert item exists
- Assert item message contains 'async' or 'await' (from inner thoughts output)
- Assert item context JSON contains source: 'inner_thoughts'
- Assert item triggerAt is a future timestamp (from timing model)

**Suite 2: "inner thoughts suppressed when user is distressed"**

Setup:
- Same as Suite 1 but seed smoothedAffect with goalSignal: 'user_distressed'
  - smoothedAffect: { valence: -0.6, arousal: 0.7, emotion: 'anxious', goalSignal: 'user_distressed' }
- Same session summary seeding

Test:
- Call gardener.deepTick()
- Query scheduled items with source='agent' AND type='follow_up'
- Assert NO items created (distress suppression blocked inner thoughts)

This validates the pre-filter guard: shouldRunInnerThoughts returns false when affect goalSignal is 'user_distressed'.
  </action>
  <verify>npm test -- src/e2e/cognitive-inner-thoughts.test.ts — first 2 suites pass</verify>
  <done>Inner thoughts creates scheduled items via deepTick, distress suppression prevents proactive items when user is distressed</done>
</task>

<task type="auto">
  <name>Task 2: Add proactive feedback loop E2E test</name>
  <files>src/e2e/cognitive-inner-thoughts.test.ts</files>
  <action>
Add third test suite.

**Suite 3: "proactive feedback loop detects engagement"**

This tests the trust calibration feedback loop: when a proactive message is fired and user responds within 15 minutes, it's detected as engagement.

Setup:
- Create ScallopMemoryStore (no gardener needed — testing feedback directly)
- Seed a scheduled item via db.addScheduledItem:
  - source: 'agent', type: 'follow_up', status: 'fired'
  - firedAt: Date.now() - 5 * 60 * 1000 (5 minutes ago — within 15-min window)
  - message: "Would you like help with that async pattern?"
- Import detectProactiveEngagement from '../proactive/feedback.js'

Test:
- Call detectProactiveEngagement('default', recentFiredItems, 15 * 60 * 1000, Date.now())
  - recentFiredItems: map the seeded scheduled item to the expected format
- Assert returned array contains the item ID (engagement detected)

Then test the negative case:
- Seed another item with firedAt = Date.now() - 20 * 60 * 1000 (20 minutes ago — outside window)
- Call detectProactiveEngagement again
- Assert the 20-min-old item is NOT in the returned array

This validates the engagement detection window that feeds into the trust score's proactiveAcceptRate.

Note: detectProactiveEngagement expects an array of items with specific shape. Check the function signature in feedback.ts to match the expected input format. The function likely needs items with { id, firedAt, status } or similar.
  </action>
  <verify>npm test -- src/e2e/cognitive-inner-thoughts.test.ts — all 3 suites pass</verify>
  <done>Proactive feedback loop correctly detects engagement within 15-min window and ignores expired items</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- src/e2e/cognitive-inner-thoughts.test.ts` passes all tests
- [ ] No TypeScript errors
- [ ] Tests run in <60s total
- [ ] Tests clean up temp DB files
</verification>

<success_criteria>

- Inner thoughts evaluation creates timed scheduled items via deepTick
- Distress suppression prevents proactive items
- Feedback loop detects user engagement within window
- All tests deterministic
</success_criteria>

<output>
After completion, create `.planning/phases/33-e2e-cognitive-testing/33-04-SUMMARY.md`
</output>
