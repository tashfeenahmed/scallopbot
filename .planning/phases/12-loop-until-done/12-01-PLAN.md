---
phase: 12-loop-until-done
plan: 01
type: execute
---

<objective>
Implement "loop until done" behavior where the agent continues working in loops until the task is complete, making an explicit stop vs continue decision each iteration.

Purpose: Transform the agent from single-response mode to autonomous task completion mode, where it chains multiple operations until the user's request is fully satisfied.
Output: Modified agent loop with completion detection and updated system prompt for loop-until-done behavior.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/11-web-ui/11-01-SUMMARY.md
@.planning/phases/07-agent-loop-refactor/07-02-SUMMARY.md

# Key files
@src/agent/agent.ts

**Tech stack available:** TypeScript, Node.js, skills-only architecture
**Established patterns:**
- Agent loop with maxIterations limit
- stopReason: 'end_turn' | 'tool_use' | 'max_tokens' | 'stop_sequence'
- ProgressCallback for streaming updates

**Constraining decisions:**
- Skills are the only execution path (no tool fallback)
- Agent already has shouldStop callback for user-initiated stops
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add task completion detection to agent loop</name>
  <files>src/agent/agent.ts</files>
  <action>
Modify the agent loop termination logic to detect explicit task completion signals:

1. Add a new helper method `isTaskComplete(textContent: string): boolean` that checks for:
   - Text ending with "[DONE]" marker (case insensitive)
   - This gives the LLM an explicit way to signal task completion

2. Update the agent loop termination condition (around line 399) from:
   ```typescript
   if (response.stopReason === 'end_turn' || toolUses.length === 0) {
   ```
   To also check for explicit completion:
   ```typescript
   const taskComplete = this.isTaskComplete(textContent);
   if (taskComplete || (response.stopReason === 'end_turn' && toolUses.length === 0)) {
   ```

3. When task is marked complete, strip the [DONE] marker from the response before returning.

4. Add a new stop reason to logging: `taskComplete` boolean in the iteration log.

AVOID: Don't change the maxIterations safety limit. Don't modify shouldStop callback behavior. Don't add new dependencies.
  </action>
  <verify>npm run build passes. Unit tests pass with `npm test -- --testPathPattern=agent`.</verify>
  <done>
- isTaskComplete method exists and detects [DONE] marker
- Agent loop checks for task completion before terminating
- [DONE] marker stripped from final response
- Build and existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update system prompt for loop-until-done behavior</name>
  <files>src/agent/agent.ts</files>
  <action>
Update DEFAULT_SYSTEM_PROMPT to instruct the agent about loop-until-done behavior:

1. Add a new section after "EXECUTION RULES:" called "TASK COMPLETION - CRITICAL:":
   ```
   TASK COMPLETION - CRITICAL:
   You operate in a loop until the user's task is FULLY complete. After each action:
   1. Evaluate: "Is the user's request completely satisfied?"
   2. If YES: End your response with [DONE] to signal completion
   3. If NO: Continue with the next action needed

   Examples of when to use [DONE]:
   - User asked to search something → you searched and presented results → [DONE]
   - User asked to create a file → you created it and confirmed → [DONE]
   - User asked a question → you answered it → [DONE]

   Examples of when NOT to use [DONE] (continue working):
   - User asked to "find and summarize" → you found results but haven't summarized yet
   - User asked to "check the weather and tell me if I need an umbrella" → you got weather but haven't advised yet
   - You encountered an error → try a different approach before giving up

   Never use [DONE] in the middle of a response - only at the very end.
   ```

2. Update the "EXECUTION RULES:" section to reinforce looping:
   - Change rule 5 from "Keep trying until you succeed or have exhausted all reasonable approaches"
   - To: "Keep trying until you succeed. Use [DONE] only when the task is fully complete."

AVOID: Don't remove existing instructions. Don't change the basic execution model. Keep the prompt under control (no excessive length).
  </action>
  <verify>npm run build passes. Manual test: Start the agent, give it a multi-step task, observe it continues until complete.</verify>
  <done>
- System prompt includes TASK COMPLETION section
- [DONE] marker usage is clearly documented
- EXECUTION RULES updated to reinforce loop behavior
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] Agent loop properly detects [DONE] marker
- [ ] System prompt includes loop-until-done instructions
- [ ] No regressions in existing agent behavior
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Agent continues working until explicitly signaling [DONE]
- Backward compatible - single-turn responses still work
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/12-loop-until-done/12-01-SUMMARY.md` following the summary template with:
- Accomplishments (completion detection, prompt updates)
- Files modified
- Any decisions made during implementation
- Next phase readiness
</output>
