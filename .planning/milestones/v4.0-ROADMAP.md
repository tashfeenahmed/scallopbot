# Milestone v4.0: Bio-Inspired Cognitive Architecture

**Status:** SHIPPED 2026-02-10
**Phases:** 24-33
**Total Plans:** 32

## Overview

Transform SmartBot from a reactive assistant into a cognitively rich personal intelligence with dreams (offline memory consolidation), emotions (affect-aware interaction), an enhanced heartbeat (persistent cognitive loop), and proactive intelligence (anticipatory gap detection) — all implemented at the application level via LLM API calls, SQLite operations, and Node.js orchestration. Based on the bio-inspired research report surveying 17 papers (Hu et al. 2025, Zhang 2026, Reflexion, MemGPT, CoALA, PROBE, etc.).

## Phases

### Phase 24: Heartbeat Tier Enhancements

**Goal**: Extend BackgroundGardener's existing 2-tier system with health monitoring, retrieval auditing, trust scoring, and goal deadline checks — laying the infrastructure all other v4.0 pillars depend on
**Depends on**: v3.0 complete
**Plans**: 5 plans

Plans:
- [x] 24-01: Health Ping & Retrieval Audit (TDD)
- [x] 24-02: Trust Score Computation (TDD)
- [x] 24-03: Goal Deadline Check (TDD)
- [x] 24-04: Wire Gardener Tick Operations
- [x] 24-05: Tier 3 Sleep Infrastructure

### Phase 25: Affect Detection

**Goal**: Build the affect classifier module — keyword-based valence/arousal detection, mood EMA signal integration into behavioral-signals.ts, and the affect.ts module that outputs {valence, arousal, emotion, goalSignal}
**Depends on**: Phase 24 (health infrastructure for affect decay in light tick)
**Plans**: 3 plans

Plans:
- [x] 25-01: Affect Classifier (TDD)
- [x] 25-02: Affect EMA Smoothing (TDD)
- [x] 25-03: Wire Affect Integration

### Phase 26: Affect Context Injection

**Goal**: Wire affect signals into ContextManager's system prompt assembly — add "User Affect Context" observation block, implement the affect guard (emotion in observation only, never instructions per Mozikov et al.), update dynamic profiles with currentMood from classifier
**Depends on**: Phase 25 (affect classifier must exist)
**Plans**: 1 plan

Plans:
- [x] 26-01: Affect Context Injection

### Phase 27: Dream NREM Consolidation

**Goal**: Implement the NREM phase of the dream cycle — expand fusion clustering from same-category to cross-category, widen prominence window to [0.05, 0.8), enrich fusion prompts with relation context, run as part of a new nightly Tier 3 (Sleep) tick
**Depends on**: Phase 24 (heartbeat tier infrastructure for Tier 3 scheduling)
**Plans**: 3 plans

Plans:
- [x] 27-01: Cross-Category Fusion Clustering (TDD)
- [x] 27-02: NREM Consolidation Module (TDD)
- [x] 27-03: Wire NREM into sleepTick

### Phase 28: Dream REM Exploration

**Goal**: Implement REM stochastic graph exploration — sample random seed memories, spread activation with high noiseSigma (0.5-0.8), LLM-judge novel connections, store confirmed links as EXTENDS relations. Create dream.ts orchestrator coordinating NREM + REM phases
**Depends on**: Phase 27 (NREM consolidation and Tier 3 Sleep tick must exist)
**Plans**: 3 plans

Plans:
- [x] 28-01: REM Exploration Module (TDD)
- [x] 28-02: Dream Orchestrator (TDD)
- [x] 28-03: Wire REM into sleepTick

### Phase 29: Enhanced Forgetting

**Goal**: Upgrade pruning from simple prominence-threshold to utility-based deletion per Hu et al. — track retrieval history (which memories are actually used in context), compute utilityScore = prominence * log(1 + accessCount), archive low-utility memories, prune orphaned relation edges
**Depends on**: Phase 24 (retrieval audit from heartbeat tracks access patterns)
**Plans**: 2 plans

Plans:
- [x] 29-01: Utility Score Computation (TDD)
- [x] 29-02: Wire Utility-Based Forgetting

### Phase 30: Self-Reflection

**Goal**: Implement daily self-reflection — retrieve day's session summaries, LLM generates process-focused reflection (per Renze & Guven taxonomy), store as insight-category memories with DERIVES relations to source sessions. Runs in Tier 3 Sleep tick after dreams
**Depends on**: Phase 27 (Tier 3 Sleep tick infrastructure)
**Plans**: 2 plans

Plans:
- [x] 30-01: Self-Reflection Module (TDD)
- [x] 30-02: Wire Reflection into sleepTick

### Phase 31: Gap Scanner

**Goal**: Build the PROBE 3-stage proactive pipeline — Stage 1 (Search): DB queries for unresolved threads, approaching deadlines, stale goals, behavioral anomalies; Stage 2 (Identify): LLM diagnoses specific gaps with user context + affect state; Stage 3 (Act): create scheduled_items gated by proactiveness dial (conservative/moderate/eager)
**Depends on**: Phase 26 (affect signals needed for Stage 2 context), Phase 24 (goal checks)
**Plans**: 4 plans

Plans:
- [x] 31-01: Gap Signal Heuristics (TDD)
- [x] 31-02: LLM Gap Diagnosis (TDD)
- [x] 31-03: Proactiveness-Gated Actions (TDD)
- [x] 31-04: Wire Gap Scanner into sleepTick

### Phase 32: Inner Thoughts & Timing

**Goal**: Post-session inner monologue — after each user session ends, run lightweight "inner thoughts" LLM evaluation of whether proactive action is warranted (per Liu et al. CHI 2025). Implement timing model: respect quiet hours, prefer session-start moments, per-channel formatting (Telegram short + expand, WebSocket structured JSON). Trust-calibrated feedback loop
**Depends on**: Phase 31 (gap scanner provides the proactive pipeline), Phase 25 (affect for suppression when stressed)
**Plans**: 4 plans

Plans:
- [x] 32-01: Inner Thoughts Module (TDD)
- [x] 32-02: Timing Model (TDD)
- [x] 32-03: Feedback Loop & Per-Channel Formatting (TDD)
- [x] 32-04: Wire Inner Thoughts & Timing into Pipeline

### Phase 33: E2E Cognitive Testing

**Goal**: Comprehensive E2E test suite validating all v4.0 features — dream cycle execution, affect detection + context injection, heartbeat tier transitions, self-reflection generation, gap scanner pipeline, inner thoughts triggering, trust calibration feedback loop. Direct-wired WebSocket tests following v3.0 E2E patterns
**Depends on**: All previous phases (24-32)
**Plans**: 5 plans

Plans:
- [x] 33-01: Affect Detection & Heartbeat E2E
- [x] 33-02: Dream Cycle E2E (NREM + REM)
- [x] 33-03: Self-Reflection & Gap Scanner E2E
- [x] 33-04: Inner Thoughts & Feedback Loop E2E
- [x] 33-05: Full Cognitive Cycle & Channel Formatting E2E

---

## Milestone Summary

**Key Decisions:**
- Plain keys (not _sig_ prefix) for trust/proactiveness behavioral patterns
- Dynamic import for cross-module tick dependencies
- Tick-counter with wall-clock gate for Tier 3 sleep scheduling
- AFINN-165 + VADER heuristics + Russell circumplex for affect classification
- Dual-EMA (fast 2h / slow 3d) for mood smoothing with goal signal derivation
- Observation-only affect guard in system prompt (per Mozikov et al.)
- crossCategory config flag for conditional category-split bypass in fusion clustering
- Relation-context-enriched NREM fusion with per-cluster error isolation
- REM stochastic exploration with noiseSigma 0.6 and category-diverse seed sampling
- Dream.ts pure coordinator pattern (sequential NREM then REM with per-phase error isolation)
- Utility-based forgetting pipeline (prominence * ln(1 + accessCount)) with soft-archive then hard-prune
- Renze & Guven Composite type for reflection with SOUL re-distillation
- GapSignal/GapScanInput types for 3-stage PROBE pipeline
- DIAL_THRESHOLDS per-dial gating (conservative/moderate/eager)
- 6-hour proactive cooldown + distress suppression for inner thoughts
- 4-strategy priority chain for delivery timing (urgent_now > next_morning > active_hours > next_active)
- Per-channel proactive formatting (Telegram icon+footer, WebSocket structured JSON)
- 'acted' DB status for trust score feedback loop

**Issues Resolved:**
- Cross-category fusion clustering needed conditional bypass (crossCategory flag)
- Orphan relation pruning required db.deleteRelation (not raw SQL)
- Fusion tests broken by utility-based forgetting pipeline changes (repaired in 33-05)
- Cold-start guard needed for null behavioral signals in gap scanning

**Issues Deferred:**
- read, write, edit skills (for future milestone)

**Technical Debt Incurred:**
- None significant — TDD approach kept debt minimal

---

_For current project status, see .planning/ROADMAP.md_
